<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CNV Super Saver</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Sinhala:wght@400;700&display=swap');
        body { font-family: 'Noto Sans Sinhala', sans-serif; background: #0f172a; color: white; }
        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        
        /* Tree Animation */
        .tree-container { transition: all 1s ease-in-out; }
        @keyframes grow { 0% { transform: scale(0.8); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        .grow-anim { animation: grow 2s infinite ease-in-out; }
        
        /* Modal Transition */
        .modal { transition: opacity 0.3s ease; }
    </style>
</head>
<body class="min-h-screen pb-20">

    <div id="loginView" class="flex flex-col justify-center items-center min-h-screen p-4">
        <h1 class="text-4xl font-bold text-yellow-400 mb-2 tracking-wider">SUPER SAVER üèÜ</h1>
        <p class="text-gray-400 mb-8 text-center">‡∑É‡∑è‡∂∏‡∑è‡∂±‡∑ä‚Äç‡∂∫ ‡∂∂‡∑ê‡∂Ç‡∂ö‡∑î‡∑Ä‡∂ö‡∑ä ‡∂±‡∑ú‡∑Ä‡∑ö, ‡∂∏‡∑ô‡∂∫ ‡∂â‡∂Ω‡∂ö‡∑ä‡∂ö ‡∂¢‡∂∫‡∂ú‡∂±‡∑ä‡∂±‡∑è ‡∂≠‡∑ê‡∂±‡∂ö‡∑ä.</p>
        <button onclick="googleLogin()" class="bg-white text-gray-900 px-6 py-3 rounded-full font-bold shadow-lg flex items-center gap-3 hover:scale-105 transition">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-6 h-6">
            Google ‡∑Ñ‡∂ª‡∑Ñ‡∑è ‡∂á‡∂≠‡∑î‡∂Ω‡∑ä ‡∑Ä‡∂±‡∑ä‡∂±
        </button>
    </div>

    <div id="termsView" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-95 p-4">
        <div class="bg-gray-800 rounded-2xl max-w-md w-full p-6 border border-yellow-500 shadow-2xl">
            <h2 class="text-xl font-bold text-yellow-400 mb-4 border-b border-gray-700 pb-2">üìú ‡∂±‡∑ì‡∂≠‡∑í ‡∑É‡∑Ñ ‡∂ö‡∑ú‡∂±‡∑ä‡∂Ø‡∑ö‡∑É‡∑í (Policy)</h2>
            <div class="h-64 overflow-y-auto text-sm text-gray-300 mb-4 bg-gray-900 p-3 rounded leading-relaxed border border-gray-700">
                <p class="mb-3"><strong class="text-white">1. ‡∂â‡∂Ω‡∂ö‡∑ä‡∂ö‡∂ú‡∂≠ ‡∂â‡∂≠‡∑í‡∂ª‡∑í‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∑ä (Goal Based):</strong> ‡∂∏‡∑ô‡∂∫ ‡∑É‡∑è‡∂∏‡∑è‡∂±‡∑ä‚Äç‡∂∫ ‡∂∂‡∑ê‡∂Ç‡∂ö‡∑î ‡∂ú‡∑í‡∂´‡∑î‡∂∏‡∂ö‡∑ä ‡∂±‡∑ú‡∑Ä‡∑ö. ‡∂î‡∂∂ ‡∂∏‡∑î‡∂Ω‡∑í‡∂±‡∑ä‡∂∏ ‡∂â‡∂Ω‡∂ö‡∑ä‡∂ö‡∂∫‡∂ö‡∑ä (Target Amount) ‡∑É‡∂ö‡∑É‡∑è ‡∂ú‡∂≠ ‡∂∫‡∑î‡∂≠‡∑î ‡∂Ö‡∂≠‡∂ª, ‡∂ë‡∂∫ ‡∑É‡∂∏‡∑ä‡∂¥‡∑ñ‡∂ª‡∑ä‡∂´ ‡∑Ä‡∂± ‡∂≠‡∑ô‡∂ö‡∑ä ‡∂∏‡∑î‡∂Ø‡∂Ω‡∑ä ‡∂ë‡∂ö‡∂≠‡∑î ‡∂ö‡∑Ö ‡∂∫‡∑î‡∂≠‡∑î‡∂∫.</p>
                <p class="mb-3"><strong class="text-white">2. ‡∂¥‡∑ú‡∂Ω‡∑ì ‡∂ú‡∑ô‡∑Ä‡∑ì‡∂∏ (Interest):</strong> ‡∂¥‡∑ú‡∂Ω‡∑ì ‡∂ú‡∑ô‡∑Ä‡∑ì‡∂∏ ‡∂Ü‡∂ª‡∂∏‡∑ä‡∂∑ ‡∑Ä‡∂±‡∑ä‡∂±‡∑ö ‡∂î‡∂∂‡∑ö ‡∂ú‡∑í‡∂´‡∑î‡∂∏‡∑ö ‡∑Å‡∑ö‡∑Ç‡∂∫ <strong>‡∂ª‡∑î. 10,000</strong> ‡∂â‡∂ö‡∑ä‡∂∏‡∑Ä‡∑ñ ‡∂¥‡∑É‡∑î‡∑Ä ‡∂¥‡∂∏‡∂´‡∑í. (Monetization Bar ‡∂ë‡∂ö ‡∂¥‡∑í‡∂ª‡∑í‡∂∫ ‡∂∫‡∑î‡∂≠‡∑î‡∂∫).</p>
                <p class="mb-3"><strong class="text-white">3. ‡∂∏‡∑î‡∂Ø‡∂Ω‡∑ä ‡∂Ü‡∂¥‡∑É‡∑î ‡∂ú‡∑ê‡∂±‡∑ì‡∂∏ (Withdrawal):</strong> ‡∂î‡∂∂‡∂ß ‡∂∏‡∑î‡∂Ø‡∂Ω‡∑ä ‡∂Ü‡∂¥‡∑É‡∑î ‡∂Ω‡∂∂‡∑è ‡∂ú‡∂≠ ‡∑Ñ‡∑ê‡∂ö‡∑ä‡∂ö‡∑ö ‡∂î‡∂∂‡∑ö Target ‡∂ë‡∂ö 100% ‡∑É‡∂∏‡∑ä‡∂¥‡∑ñ‡∂ª‡∑ä‡∂´ ‡∑Ä‡∑ñ ‡∑Ä‡∑í‡∂ß ‡∂¥‡∂∏‡∂´‡∑í.</p>
                <p class="mb-3"><strong class="text-white">4. ‡∂Ø‡∑í‡∂±‡∂¥‡∂≠‡∑è ‡∂≠‡∑ê‡∂±‡∑ä‡∂¥‡∂≠‡∑î:</strong> ‡∂â‡∂Ω‡∂ö‡∑ä‡∂ö‡∂∫ ‡∂ö‡∂ª‡∑è ‡∂∫‡∑è‡∂∏‡∂ß ‡∂î‡∂∂ ‡∂Ø‡∑í‡∂±‡∂¥‡∂≠‡∑è ‡∑Ñ‡∑ù ‡∑É‡∂≠‡∑í‡∂¥‡∂≠‡∑è ‡∂∏‡∑î‡∂Ø‡∂Ω‡∑ä ‡∂≠‡∑ê‡∂±‡∑ä‡∂¥‡∂≠‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∂ß ‡∂ã‡∂±‡∂±‡∑ä‡∂Ø‡∑î ‡∑Ä‡∑í‡∂∫ ‡∂∫‡∑î‡∂≠‡∑î‡∂∫.</p>
                <p class="text-xs text-gray-500 mt-4">* ‡∂â‡∂Ø‡∑í‡∂ª‡∑í‡∂∫‡∂ß ‡∂∫‡∑è‡∂∏‡∑ô‡∂±‡∑ä ‡∂î‡∂∂ ‡∂∏‡∑ô‡∂∏ ‡∂ö‡∑ú‡∂±‡∑ä‡∂Ø‡∑ö‡∑É‡∑í ‡∑Ä‡∂Ω‡∂ß ‡∂ë‡∂ö‡∂ü ‡∑Ä‡∑ö.</p>
            </div>
            <button onclick="acceptTerms()" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-xl shadow-lg transform active:scale-95 transition">‡∂∏‡∂∏ ‡∂ë‡∂ö‡∂ü‡∂∫‡∑í (I Accept) ‚úÖ</button>
        </div>
    </div>

    <div id="setupView" class="hidden min-h-screen flex flex-col justify-center items-center p-4 bg-gray-900 z-40 fixed inset-0">
        <div class="glass p-6 rounded-2xl w-full max-w-md text-center border border-gray-600">
            <h2 class="text-2xl font-bold mb-2 text-yellow-400">üéØ ‡∂Ö‡∂Ω‡∑î‡∂≠‡∑ä ‡∂â‡∂Ω‡∂ö‡∑ä‡∂ö‡∂∫‡∂ö‡∑ä (New Target)</h2>
            <p class="text-gray-400 text-sm mb-6">‡∂î‡∂∂‡∂ß ‡∂ä‡∑Ö‡∂ü‡∂ß ‡∂ë‡∂ö‡∂≠‡∑î ‡∂ö‡∂ª‡∂±‡∑ä‡∂± ‡∂Ö‡∑Ä‡∑Å‡∑ä‚Äç‡∂∫ ‡∂∏‡∑î‡∑Ö‡∑î ‡∂∏‡∑î‡∂Ø‡∂Ω ‡∂ö‡∑ì‡∂∫‡∂Ø?</p>
            
            <input type="number" id="targetAmountInput" placeholder="Ex: 100000" class="w-full p-4 bg-gray-800 border border-gray-600 rounded-xl text-white text-xl font-bold text-center mb-6 focus:border-yellow-500 outline-none">
            
            <div class="flex gap-2">
                <button onclick="cancelSetup()" id="btnCancelSetup" class="hidden flex-1 bg-gray-600 text-white font-bold py-3 rounded-xl">Cancel</button>
                <button onclick="saveTarget()" class="flex-1 bg-gradient-to-r from-yellow-500 to-yellow-600 text-black font-bold py-3 rounded-xl shadow-lg">Target ‡∂ë‡∂ö ‡∑É‡∑ô‡∂ß‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂± üöÄ</button>
            </div>
        </div>
    </div>

    <div id="dashboardView" class="hidden p-4 max-w-md mx-auto">
        <div class="flex justify-between items-center mb-4">
            <div>
                <h2 class="text-xl font-bold" id="userName">User</h2>
                <div class="flex items-center gap-1 bg-orange-900/50 px-2 py-1 rounded-lg border border-orange-500/30 mt-1">
                    <span class="text-lg">üî•</span>
                    <span id="streakCount" class="text-orange-400 font-bold text-sm">0 Days Streak!</span>
                </div>
            </div>
            <img id="userImg" src="" class="w-12 h-12 rounded-full border-2 border-yellow-500">
        </div>

        <div class="glass p-6 rounded-3xl mb-4 text-center relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-full bg-green-500/5 z-0"></div>
            <p class="text-xs text-green-300 uppercase tracking-widest relative z-10">My Savings Tree</p>
            <div class="my-4 relative z-10 flex justify-center items-center h-32">
                <div id="treeIcon" class="text-9xl drop-shadow-2xl tree-container">üå±</div>
            </div>
            <h1 class="text-3xl font-bold text-white relative z-10">Rs. <span id="balanceDisplay">0.00</span></h1>
            <p class="text-xs text-gray-400 mt-1 relative z-10">Target: Rs. <span id="targetDisplay">0</span></p>
        </div>

        <div class="mb-6">
            <button id="btnSetTarget" onclick="openTargetSetup()" class="w-full bg-gray-700 text-gray-400 font-bold py-3 rounded-xl shadow-lg flex justify-center items-center gap-2 cursor-not-allowed opacity-50 transition-all duration-300" disabled>
                <span>üîí</span> Target Locked (Finish current first)
            </button>
        </div>

        <div class="glass p-4 rounded-2xl mb-6">
            <div class="flex justify-between text-xs text-gray-400 mb-1">
                <span>Target Progress</span>
                <span id="targetPercentText">0%</span>
            </div>
            <div class="w-full bg-gray-700 rounded-full h-3 mb-4">
                <div id="targetBar" class="bg-blue-500 h-3 rounded-full transition-all duration-1000" style="width: 0%"></div>
            </div>

            <div class="flex justify-between text-xs text-gray-400 mb-1">
                <span>Monetization (Interest > 10k)</span>
                <span id="moneyPercentText">0%</span>
            </div>
            <div class="w-full bg-gray-700 rounded-full h-3">
                <div id="moneyBar" class="bg-yellow-600 h-3 rounded-full transition-all duration-1000" style="width: 0%"></div>
            </div>
            <p id="interestStatus" class="text-[10px] text-right mt-1 text-gray-500">Reach 10k to unlock interest üîí</p>
        </div>

        <div class="glass p-4 rounded-2xl mb-6">
            <h3 class="text-sm font-bold text-yellow-400 mb-3 flex items-center gap-2">üèÜ Top Savers (% Completed)</h3>
            <div id="leaderboardList" class="space-y-2">
                <p class="text-xs text-gray-500">Loading...</p>
            </div>
        </div>

        <div class="glass p-4 rounded-2xl border-l-4 border-red-500 relative">
            <h3 class="font-bold text-gray-200 mb-2">Withdraw Money</h3>
            
            <div id="withdrawLock" class="absolute inset-0 bg-gray-900/95 backdrop-blur-sm z-20 flex flex-col items-center justify-center rounded-r-2xl text-center p-4">
                <span class="text-2xl mb-1">üîí</span>
                <h4 class="text-red-400 font-bold text-sm">Target Not Met!</h4>
                <p class="text-[10px] text-gray-400">Withdrawal unlocks at 100%.</p>
            </div>

            <div id="withdrawForm" class="hidden">
                <div class="flex gap-2 mb-3">
                    <label class="flex-1 cursor-pointer"><input type="radio" name="wType" value="cash" checked class="peer hidden"><div class="bg-gray-700 peer-checked:bg-green-600 p-2 rounded text-center text-xs text-gray-300 peer-checked:text-white transition">Cash üíµ</div></label>
                    <label class="flex-1 cursor-pointer"><input type="radio" name="wType" value="bank" class="peer hidden" onchange="toggleBank()"><div class="bg-gray-700 peer-checked:bg-blue-600 p-2 rounded text-center text-xs text-gray-300 peer-checked:text-white transition">Bank üè¶</div></label>
                </div>
                <input type="number" id="wAmount" placeholder="Amount (Rs)" class="w-full p-2 bg-gray-900 border border-gray-600 rounded mb-2 text-white text-sm">
                <div id="bankF" class="hidden space-y-2 mb-2">
                    <input type="text" id="bName" placeholder="Bank Name" class="w-full p-2 bg-gray-900 border border-gray-600 rounded text-xs text-white">
                    <input type="text" id="bAcc" placeholder="Account No" class="w-full p-2 bg-gray-900 border border-gray-600 rounded text-xs text-white">
                </div>
                <button onclick="requestWithdraw()" class="w-full bg-red-600 hover:bg-red-500 text-white font-bold py-2 rounded shadow text-sm">Request Withdraw üîì</button>
            </div>
            
            <div id="dummyForm" class="opacity-30 pointer-events-none">
                <div class="flex gap-2 mb-2"><div class="flex-1 bg-gray-700 h-8 rounded"></div><div class="flex-1 bg-gray-700 h-8 rounded"></div></div>
                <div class="bg-gray-700 h-10 rounded w-full mb-2"></div>
                <div class="bg-gray-600 h-10 rounded w-full"></div>
            </div>
        </div>
        
        <button onclick="logout()" class="w-full mt-8 text-gray-500 text-sm mb-10">Logout</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDoc, setDoc, doc, onSnapshot, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBQ4b_qLp51HXYJc0Trtp6yG0lO7XSudQk",
            authDomain: "cnvbankbyuandy.firebaseapp.com",
            projectId: "cnvbankbyuandy",
            storageBucket: "cnvbankbyuandy.firebasestorage.app",
            messagingSenderId: "654524804107",
            appId: "1:654524804107:web:839811f4eb33b914786b0e",
            measurementId: "G-PWWVKS8EEM"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        
        let currentUser = null;

        // Navigation Helper
        function showView(viewId) {
            ['loginView', 'termsView', 'setupView', 'dashboardView'].forEach(id => {
                const el = document.getElementById(id);
                if(id === viewId) el.classList.remove('hidden');
                else el.classList.add('hidden');
            });
        }

        window.googleLogin = () => signInWithPopup(auth, provider).catch(e => alert(e.message));
        window.logout = () => signOut(auth).then(() => location.reload());

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const userRef = doc(db, "users", user.uid);
                const snap = await getDoc(userRef);

                if (!snap.exists()) {
                    // New User -> Terms
                    await setDoc(userRef, {
                        name: user.displayName, email: user.email, photo: user.photoURL,
                        balance: 0, target: 0, streak: 0, termsAccepted: false
                    });
                    showView('termsView');
                } else {
                    const data = snap.data();
                    if (!data.termsAccepted) {
                        showView('termsView');
                    } else if (!data.target || data.target === 0) {
                        // User accepted terms but hasn't set target
                        document.getElementById('btnCancelSetup').classList.add('hidden'); // Cannot cancel initial setup
                        showView('setupView');
                    } else {
                        loadDashboard(data);
                    }
                }
            } else {
                showView('loginView');
            }
        });

        // 1. TERMS LOGIC
        window.acceptTerms = async () => {
            await setDoc(doc(db, "users", currentUser.uid), { termsAccepted: true }, { merge: true });
            // After accepting, go to setup
            document.getElementById('btnCancelSetup').classList.add('hidden');
            showView('setupView');
        };

        // 2. TARGET LOGIC
        window.openTargetSetup = () => {
            // Can cancel if coming from dashboard
            document.getElementById('btnCancelSetup').classList.remove('hidden'); 
            showView('setupView');
        };

        window.cancelSetup = () => {
            showView('dashboardView');
        };

        window.saveTarget = async () => {
            const amount = parseFloat(document.getElementById('targetAmountInput').value);
            if(!amount || amount <= 0) return alert("Please enter a valid target amount.");
            
            await setDoc(doc(db, "users", currentUser.uid), { target: amount }, { merge: true });
            location.reload(); // Reload to refresh dashboard logic
        };

        // 3. DASHBOARD LOGIC
        function loadDashboard(userData) {
            showView('dashboardView');
            document.getElementById('userName').innerText = userData.name.split(" ")[0];
            document.getElementById('userImg').src = userData.photo;

            onSnapshot(doc(db, "users", currentUser.uid), (doc) => {
                const d = doc.data();
                const bal = d.balance || 0;
                const target = d.target || 1; // Avoid divide by zero
                const streak = d.streak || 0;

                // STREAK
                const streakEl = document.getElementById('streakCount');
                streakEl.innerText = `${streak} Days Streak!`;
                if(streak > 3) streakEl.innerText += " üî•";

                // TREE
                const pct = (bal / target) * 100;
                let treeIcon = "üå±";
                if (pct > 10) treeIcon = "üåø";
                if (pct > 40) treeIcon = "üå≥";
                if (pct > 80) treeIcon = "üå≤";
                if (pct >= 100) treeIcon = "üéÑ";
                
                const treeEl = document.getElementById('treeIcon');
                treeEl.innerText = treeIcon;
                if(pct > 0) treeEl.classList.add('grow-anim');

                // BALANCE & TEXT
                document.getElementById('balanceDisplay').innerText = bal.toFixed(2);
                document.getElementById('targetDisplay').innerText = target;
                document.getElementById('targetBar').style.width = `${Math.min(pct, 100)}%`;
                document.getElementById('targetPercentText').innerText = `${pct.toFixed(1)}%`;

                // MONETIZATION (10k)
                const moneyPct = Math.min((bal / 10000) * 100, 100);
                document.getElementById('moneyBar').style.width = `${moneyPct}%`;
                if(bal >= 10000) {
                    document.getElementById('moneyBar').classList.add('bg-green-500');
                    document.getElementById('interestStatus').innerText = "Interest Active ‚úÖ";
                    document.getElementById('interestStatus').classList.replace('text-gray-500', 'text-green-400');
                }

                // --- BUTTON LOCK LOGIC ---
                const btnSetTarget = document.getElementById('btnSetTarget');
                if (bal >= target && bal > 0) {
                    // Unlocked
                    btnSetTarget.disabled = false;
                    btnSetTarget.classList.remove('opacity-50', 'cursor-not-allowed', 'bg-gray-700', 'text-gray-400');
                    btnSetTarget.classList.add('bg-yellow-500', 'hover:bg-yellow-400', 'text-black', 'cursor-pointer');
                    btnSetTarget.innerHTML = `<span>üéØ</span> Set New Target (Completed!)`;
                } else {
                    // Locked
                    btnSetTarget.disabled = true;
                    btnSetTarget.classList.add('opacity-50', 'cursor-not-allowed', 'bg-gray-700', 'text-gray-400');
                    btnSetTarget.classList.remove('bg-yellow-500', 'hover:bg-yellow-400', 'text-black', 'cursor-pointer');
                    btnSetTarget.innerHTML = `<span>üîí</span> Target Locked (Finish current first)`;
                }

                // --- WITHDRAWAL LOCK LOGIC ---
                if (bal >= target && bal > 0) {
                    document.getElementById('withdrawLock').classList.add('hidden');
                    document.getElementById('withdrawForm').classList.remove('hidden');
                    document.getElementById('dummyForm').classList.add('hidden');
                } else {
                    document.getElementById('withdrawLock').classList.remove('hidden');
                    document.getElementById('withdrawForm').classList.add('hidden');
                    document.getElementById('dummyForm').classList.remove('hidden');
                }
            });

            loadLeaderboard();
        }

        async function loadLeaderboard() {
            const q = query(collection(db, "users")); 
            const snap = await getDocs(q);
            let users = [];
            snap.forEach(d => {
                const u = d.data();
                if(u.balance > 0 && u.target > 0) {
                    const pct = (u.balance / u.target) * 100;
                    users.push({ name: u.name, pct: pct });
                }
            });
            users.sort((a, b) => b.pct - a.pct);
            
            const list = document.getElementById('leaderboardList');
            list.innerHTML = "";
            users.slice(0, 3).forEach((u, index) => {
                let medal = index === 0 ? 'ü•á' : (index === 1 ? 'ü•à' : 'ü•â');
                list.innerHTML += `
                    <div class="flex justify-between items-center bg-gray-800 p-2 rounded border border-gray-700">
                        <div class="flex items-center gap-2">
                            <span>${medal}</span>
                            <span class="text-sm text-gray-300">${u.name.split(" ")[0]}</span>
                        </div>
                        <span class="text-xs font-bold text-blue-400">${u.pct.toFixed(1)}% Done</span>
                    </div>
                `;
            });
        }

        window.toggleBank = () => {
            const isBank = document.querySelector('input[name="wType"]:checked').value === 'bank';
            const el = document.getElementById('bankF');
            if(isBank) el.classList.remove('hidden'); else el.classList.add('hidden');
        };

        window.requestWithdraw = async () => {
            const amount = parseFloat(document.getElementById('wAmount').value);
            if(!amount) return alert("Enter amount");
            
            const method = document.querySelector('input[name="wType"]:checked').value;
            let details = "Cash";
            if(method === 'bank') {
                const bName = document.getElementById('bName').value;
                const bAcc = document.getElementById('bAcc').value;
                if(!bName || !bAcc) return alert("Bank details required");
                details = `${bName} - ${bAcc}`;
            }

            await addDoc(collection(db, "transactions"), {
                userId: currentUser.uid, userName: currentUser.displayName,
                type: "withdraw", amount: amount, method: method, details: details,
                status: "pending", date: new Date()
            });
            alert("Withdrawal Requested! Waiting for Admin.");
        };
    </script>
</body>
</html>
