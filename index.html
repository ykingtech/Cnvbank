<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CNV Bank</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Sinhala:wght@400;700&display=swap');
        body { font-family: 'Noto Sans Sinhala', sans-serif; overflow-x: hidden; }
        #canvas-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: linear-gradient(to bottom, #0f172a, #1e3a8a); }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .image-preview { width: 100%; height: 150px; object-fit: contain; border-radius: 8px; display: none; margin-top: 10px; border: 2px dashed #cbd5e1; background: #f8fafc; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <div id="canvas-container"></div>

    <div id="loginView" class="flex-1 flex flex-col justify-center items-center p-4 min-h-screen">
        <div class="glass p-8 rounded-2xl shadow-2xl max-w-sm w-full text-center border border-white/50">
            <h1 class="text-3xl font-bold text-blue-900 mb-2">CNV BANK üè¶</h1>
            <p class="text-gray-500 mb-8">Secure & Smart Banking</p>
            <button onclick="googleLogin()" class="w-full flex items-center justify-center gap-3 bg-white border border-gray-200 p-4 rounded-xl shadow-md hover:bg-gray-50 transition transform active:scale-95">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-6 h-6">
                <span class="font-bold text-gray-700">Google Login</span>
            </button>
        </div>
    </div>

    <div id="setupView" class="hidden min-h-screen flex flex-col justify-center items-center p-4">
        <div class="glass p-6 rounded-2xl shadow-2xl max-w-md w-full border-l-4 border-yellow-500">
            <h2 class="text-xl font-bold text-gray-800 mb-2">‡∂ú‡∑í‡∂´‡∑î‡∂∏ ‡∑É‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫ ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏ ‚ö†Ô∏è</h2>
            <label class="block text-sm font-bold text-gray-700 mt-3">‡∂∂‡∑ê‡∂Ç‡∂ö‡∑î‡∑Ä‡∑ö ‡∂±‡∂∏</label>
            <input type="text" id="regBankName" placeholder="‡∂ã‡∂Ø‡∑è: BOC / Commercial" class="w-full p-2 border rounded bg-gray-50">
            <label class="block text-sm font-bold text-gray-700 mt-3">‡∑Å‡∑è‡∂õ‡∑è‡∑Ä (Branch)</label>
            <input type="text" id="regBranchName" placeholder="‡∂ã‡∂Ø‡∑è: ‡∂ö‡∑î‡∂ª‡∑î‡∂´‡∑ë‡∂ú‡∂Ω" class="w-full p-2 border rounded bg-gray-50">
            <label class="block text-sm font-bold text-gray-700 mt-3">‡∂ú‡∑í‡∂´‡∑î‡∂∏‡∑ä ‡∂Ö‡∂Ç‡∂ö‡∂∫</label>
            <input type="number" id="regAccNo" placeholder="Account Number" class="w-full p-2 border rounded bg-gray-50">
            <label class="block text-sm font-bold text-gray-700 mt-3">NIC ‡∑Ü‡∑ú‡∂ß‡∑ù ‡∂ë‡∂ö</label>
            <input type="file" id="regNicFile" accept="image/*" class="w-full text-sm text-gray-500 mt-1" onchange="processImage(this, 'nicPreview')">
            <img id="nicPreview" class="image-preview">
            <button onclick="completeProfile()" id="saveProfileBtn" class="w-full bg-blue-700 text-white p-3 rounded-xl font-bold mt-6 shadow hover:bg-blue-800">‡∂≠‡∑Ñ‡∑Ä‡∑î‡∂ª‡∑î ‡∂ö‡∂ª‡∂±‡∑ä‡∂± ‚úÖ</button>
        </div>
    </div>

    <div id="dashboardView" class="hidden flex-col min-h-screen p-4 max-w-md mx-auto w-full relative z-10 pb-20">
        <div class="bg-gradient-to-r from-blue-600 to-indigo-800 p-6 rounded-3xl text-white shadow-xl mb-6">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-blue-200 text-xs uppercase tracking-wider">Total Balance</p>
                    <h1 class="text-4xl font-bold mt-1">Rs. <span id="userBalance">0.00</span></h1>
                </div>
                <img id="userPhoto" src="" class="w-12 h-12 rounded-full border-2 border-white/50">
            </div>
            <p class="mt-4 text-sm font-medium">Hello, <span id="displayName">User</span> üëã</p>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-6">
            <button onclick="toggleSection('depositBox')" class="bg-white p-5 rounded-2xl shadow-lg hover:shadow-xl transition active:scale-95 text-center">
                <div class="text-3xl mb-1">üì•</div>
                <div class="font-bold text-gray-700">‡∂≠‡∑ê‡∂±‡∑ä‡∂¥‡∂≠‡∑ä</div>
            </button>
            <button onclick="toggleSection('withdrawBox')" class="bg-white p-5 rounded-2xl shadow-lg hover:shadow-xl transition active:scale-95 text-center">
                <div class="text-3xl mb-1">üì§</div>
                <div class="font-bold text-gray-700">‡∂ú‡∑ê‡∂±‡∑ì‡∂∏‡∑ä</div>
            </button>
        </div>

        <button onclick="toggleSection('historyBox')" class="w-full bg-slate-800 text-white p-3 rounded-xl font-bold shadow-lg mb-4 flex justify-between items-center px-6">
            <span>üìú ‡∂ú‡∂±‡∑î‡∂Ø‡∑ô‡∂±‡∑î ‡∂â‡∂≠‡∑í‡∑Ñ‡∑è‡∑É‡∂∫</span>
            <span>‚ûî</span>
        </button>

        <div id="depositBox" class="hidden glass p-5 rounded-2xl shadow-lg mb-4 border-l-4 border-green-500 animate-fade-in">
            <div class="bg-yellow-50 p-4 rounded-xl border border-yellow-200 text-center mb-4">
                <h3 class="text-red-700 font-bold text-xl">PEOPLE'S BANK</h3>
                <p class="text-xs text-gray-500 font-bold uppercase">Kurunegala Maliyadewa Branch</p>
                <div class="my-3 text-left bg-white p-3 rounded border border-yellow-100">
                    <p class="text-[10px] text-gray-400 uppercase tracking-widest">Account Name</p>
                    <p class="text-xs font-bold text-gray-800 leading-tight">MR UVINDU INDUWARA BANDARA THENNAKOON...</p>
                </div>
                <div class="flex items-center justify-center gap-2 mt-1 bg-white p-2 rounded border border-yellow-100 shadow-sm">
                    <span class="text-lg font-bold text-gray-800 tracking-wider">226-2-001-5-0072312</span>
                    <button onclick="navigator.clipboard.writeText('226200150072312'); alert('Copied!');" class="text-xs bg-gray-200 hover:bg-gray-300 p-2 rounded font-bold">üìã Copy</button>
                </div>
            </div>
            <input type="number" id="depositAmount" placeholder="‡∂≠‡∑ê‡∂±‡∑ä‡∂¥‡∂≠‡∑ä ‡∂ö‡∑Ö ‡∂∏‡∑î‡∂Ø‡∂Ω (Rs)" class="w-full p-3 border rounded-xl mb-3 text-center font-bold">
            <label class="block text-sm font-bold text-gray-600 mb-1">Slip ‡∂ë‡∂ö‡∑ö ‡∑Ü‡∑ú‡∂ß‡∑ù ‡∂ë‡∂ö‡∂ö‡∑ä ‡∂Ø‡∑è‡∂±‡∑ä‡∂± üëá</label>
            <input type="file" id="depositSlipFile" accept="image/*" class="w-full text-sm text-gray-500 mb-2" onchange="processImage(this, 'slipPreview')">
            <img id="slipPreview" class="image-preview mb-3">
            <button onclick="requestDeposit()" id="depositBtn" class="w-full bg-green-600 text-white p-3 rounded-xl font-bold shadow-lg">‡∂â‡∂Ω‡∑ä‡∂Ω‡∑ì‡∂∏ ‡∂∫‡∑Ä‡∂±‡∑ä‡∂±</button>
        </div>

        <div id="withdrawBox" class="hidden glass p-5 rounded-2xl shadow-lg mb-4 border-l-4 border-red-500 animate-fade-in">
            <h3 class="font-bold text-gray-800 mb-2">‡∂∏‡∑î‡∂Ø‡∂Ω‡∑ä ‡∂Ü‡∂¥‡∑É‡∑î ‡∂ú‡∑ê‡∂±‡∑ì‡∂∏</h3>
            <input type="number" id="withdrawAmount" placeholder="‡∂ú‡∂±‡∑ä‡∂±‡∑è ‡∂∏‡∑î‡∂Ø‡∂Ω (Rs)" class="w-full p-3 border rounded-xl mb-3 text-center font-bold">
            <button onclick="requestWithdraw()" class="w-full bg-red-600 text-white p-3 rounded-xl font-bold shadow-lg">WhatsApp ‡∂â‡∂Ω‡∑ä‡∂Ω‡∑ì‡∂∏ ‡∂∫‡∑Ä‡∂±‡∑ä‡∂±</button>
        </div>

        <div id="historyBox" class="hidden glass p-4 rounded-2xl shadow-lg mb-4">
            <h3 class="font-bold text-gray-800 mb-4 border-b pb-2">‡∂∏‡∑ë‡∂≠ ‡∂ö‡∑è‡∂Ω‡∑ì‡∂± ‡∂ú‡∂±‡∑î‡∂Ø‡∑ô‡∂±‡∑î</h3>
            <div id="historyList" class="space-y-3">
                <p class="text-center text-gray-400 text-sm">‡∂¥‡∑ê‡∂ª‡∂´‡∑í ‡∂Ø‡∂≠‡∑ä‡∂≠ ‡∂±‡∑ê‡∂≠.</p>
            </div>
        </div>

        <button onclick="logout()" class="w-full bg-gray-200 text-gray-700 p-3 rounded-xl font-bold mt-auto">Logout</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDoc, setDoc, doc, onSnapshot, query, where, updateDoc, orderBy, limit } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBQ4b_qLp51HXYJc0Trtp6yG0lO7XSudQk",
            authDomain: "cnvbankbyuandy.firebaseapp.com",
            projectId: "cnvbankbyuandy",
            storageBucket: "cnvbankbyuandy.firebasestorage.app",
            messagingSenderId: "654524804107",
            appId: "1:654524804107:web:839811f4eb33b914786b0e",
            measurementId: "G-PWWVKS8EEM"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        const ADMIN_WHATSAPP = "94726284277";
        let currentUser = null, userData = null;

        window.toggleSection = (id) => {
            ['depositBox', 'withdrawBox', 'historyBox'].forEach(box => document.getElementById(box).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        };

        window.googleLogin = () => signInWithPopup(auth, provider).catch(err => alert("Login Error"));

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const userRef = doc(db, "users", user.uid);
                const userSnap = await getDoc(userRef);

                if (!userSnap.exists()) {
                    await setDoc(userRef, { name: user.displayName, email: user.email, photo: user.photoURL, balance: 0, profileComplete: false });
                    document.getElementById('loginView').classList.add('hidden');
                    document.getElementById('setupView').classList.remove('hidden');
                } else {
                    userData = userSnap.data();
                    if (!userData.profileComplete) {
                        document.getElementById('loginView').classList.add('hidden');
                        document.getElementById('setupView').classList.remove('hidden');
                    } else {
                        loadDashboard();
                    }
                }
            } else {
                document.getElementById('dashboardView').classList.add('hidden');
                document.getElementById('loginView').classList.remove('hidden');
            }
        });

        let tempImages = { nicPreview: "", slipPreview: "" };
        window.processImage = (input, previewId) => {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById(previewId).src = e.target.result;
                    document.getElementById(previewId).style.display = 'block';
                    const img = new Image(); img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const scale = 600 / img.width;
                        canvas.width = 600; canvas.height = img.height * scale;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        tempImages[previewId] = canvas.toDataURL('image/jpeg', 0.7);
                    };
                };
                reader.readAsDataURL(input.files[0]);
            }
        };

        window.completeProfile = async () => {
            const bName = document.getElementById('regBankName').value, branch = document.getElementById('regBranchName').value, acc = document.getElementById('regAccNo').value;
            if(!bName || !branch || !acc || !tempImages['nicPreview']) return alert("‡∑É‡∑í‡∂∫‡∂Ω‡∑î ‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª ‡∂Ö‡∑Ä‡∑Å‡∑ä‚Äç‡∂∫‡∂∫‡∑í.");
            document.getElementById('saveProfileBtn').innerText = "Saving...";
            await updateDoc(doc(db, "users", currentUser.uid), { bankName: bName, bankBranch: branch, bankAcc: acc, nicImage: tempImages['nicPreview'], profileComplete: true });
            location.reload();
        };

        function loadDashboard() {
            document.getElementById('loginView').classList.add('hidden');
            document.getElementById('setupView').classList.add('hidden');
            document.getElementById('dashboardView').classList.remove('hidden');
            document.getElementById('displayName').innerText = currentUser.displayName.split(" ")[0];
            document.getElementById('userPhoto').src = currentUser.photoURL;
            onSnapshot(doc(db, "users", currentUser.uid), (doc) => document.getElementById('userBalance').innerText = doc.data().balance.toFixed(2));
            loadHistory();
        }

        function loadHistory() {
            const q = query(collection(db, "transactions"), where("userId", "==", currentUser.uid), orderBy("date", "desc"), limit(10));
            onSnapshot(q, (snapshot) => {
                const list = document.getElementById('historyList');
                list.innerHTML = "";
                if(snapshot.empty) { list.innerHTML = "<p class='text-center text-gray-400'>No records.</p>"; return; }
                snapshot.forEach(doc => {
                    const t = doc.data();
                    const isDep = t.type === 'deposit';
                    const statusColor = t.status === 'success' ? 'text-green-500' : 'text-yellow-500';
                    const icon = t.status === 'success' ? '‚úÖ' : '‚è≥';
                    
                    list.innerHTML += `
                        <div class="flex justify-between items-center p-3 rounded bg-white border border-gray-100 shadow-sm">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full ${isDep?'bg-green-100 text-green-600':'bg-red-100 text-red-600'} flex items-center justify-center font-bold text-xs">${isDep?'IN':'OUT'}</div>
                                <div>
                                    <p class="font-bold text-gray-700 text-sm">${isDep ? 'Deposit' : 'Withdraw'}</p>
                                    <p class="text-[10px] text-gray-400">${new Date(t.date.seconds*1000).toLocaleDateString()}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="font-bold text-gray-800">Rs.${t.amount}</p>
                                <p class="text-[10px] ${statusColor} font-bold uppercase">${t.status} ${icon}</p>
                            </div>
                        </div>
                    `;
                });
            });
        }

        window.requestDeposit = async () => {
            const amount = parseFloat(document.getElementById('depositAmount').value);
            if (!amount || !tempImages['slipPreview']) return alert("‡∂∏‡∑î‡∂Ø‡∂Ω ‡∑É‡∑Ñ Slip ‡∂ë‡∂ö ‡∂Ö‡∑Ä‡∑Å‡∑ä‚Äç‡∂∫‡∂∫‡∑í");
            document.getElementById('depositBtn').innerText = "Sending...";
            await addDoc(collection(db, "transactions"), { userId: currentUser.uid, userName: currentUser.displayName, type: "deposit", amount, status: "pending", slipImage: tempImages['slipPreview'], date: new Date() });
            alert("Sent!"); location.reload();
        };

        window.requestWithdraw = async () => {
            const amount = parseFloat(document.getElementById('withdrawAmount').value);
            if (!amount) return alert("‡∂∏‡∑î‡∂Ø‡∂Ω ‡∂Ö‡∑Ä‡∑Å‡∑ä‚Äç‡∂∫‡∂∫‡∑í");
            await addDoc(collection(db, "transactions"), { userId: currentUser.uid, userName: currentUser.displayName, userBankDetails: `${userData.bankName} (${userData.bankBranch}) - ${userData.bankAcc}`, type: "withdraw", amount, status: "pending", date: new Date() });
            window.open(`https://wa.me/${ADMIN_WHATSAPP}?text=Withdraw Request: Rs. ${amount}`, '_blank');
            location.reload();
        };

        window.logout = () => signOut(auth).then(() => location.reload());

        const scene = new THREE.Scene(); const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ alpha: true }); renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('canvas-container').appendChild(renderer.domElement);
        const geo = new THREE.BufferGeometry(); const pos = new Float32Array(500 * 3);
        for(let i=0; i<1500; i++) pos[i] = (Math.random()-0.5) * 10;
        geo.setAttribute('position', new THREE.BufferAttribute(pos, 3));
        const mat = new THREE.PointsMaterial({ size: 0.05, color: 0x4f46e5 });
        const mesh = new THREE.Points(geo, mat); scene.add(mesh); camera.position.z = 5;
        function animate() { requestAnimationFrame(animate); mesh.rotation.y += 0.002; renderer.render(scene, camera); } animate();
    </script>
</body>
</html>
