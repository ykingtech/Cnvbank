<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CNV Super Saver</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#eab308">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2830/2830284.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Sinhala:wght@400;700&display=swap');
        body { font-family: 'Noto Sans Sinhala', sans-serif; background: #0f172a; color: white; user-select: none; }
        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .wheel { transition: transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99); }
        .loader-container { position: fixed; inset: 0; background: #0f172a; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .bouncing-tree { font-size: 4rem; animation: bounce 1.5s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }
        .loading-text { margin-top: 20px; color: #eab308; font-weight: bold; letter-spacing: 2px; animation: pulse 2s infinite; }
        .rank-1 { background: #FFD700; color: black; box-shadow: 0 0 10px #FFD700; }
        .rank-2 { background: #C0C0C0; color: black; }
        .rank-3 { background: #CD7F32; color: black; }
    </style>
</head>
<body class="min-h-screen pb-24">

    <div id="installPrompt" class="hidden fixed bottom-4 left-4 right-4 bg-gray-800 p-4 rounded-xl border border-yellow-500 shadow-2xl z-50 flex justify-between items-center animate-bounce">
        <div><p class="font-bold text-white">Install App üì≤</p></div>
        <button onclick="installApp()" class="bg-yellow-500 text-black font-bold px-4 py-2 rounded-lg">Install</button>
    </div>

    <div id="loadingView" class="loader-container">
        <div class="bouncing-tree">üå±</div>
        <h2 class="loading-text">CNV BANK...</h2>
    </div>

    <div id="loginView" class="hidden flex flex-col justify-center items-center min-h-screen p-4">
        <h1 class="text-4xl font-bold text-yellow-400 mb-2 tracking-wider">CNV BANK üèÜ</h1>
        <p class="text-gray-400 mb-8 text-center">Save Smart. Win Big.</p>
        <button onclick="googleLogin()" class="bg-white text-gray-900 px-6 py-3 rounded-full font-bold shadow-lg flex items-center gap-3 hover:scale-105 transition mb-4">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-6 h-6"> Google Login
        </button>
        <button onclick="document.getElementById('termsModal').classList.remove('hidden')" class="text-xs text-gray-500 underline">Read Terms & Conditions</button>
    </div>

    <div id="dashboardView" class="hidden p-4 max-w-md mx-auto">
        <div class="flex justify-between items-center mb-4">
            <div>
                <h2 class="text-xl font-bold" id="userName">User</h2>
                <div class="flex items-center gap-2">
                    <span class="bg-orange-900/50 px-2 py-1 rounded text-xs text-orange-400 border border-orange-500/30">üî• <span id="streakCount">0</span> Days</span>
                    <span class="bg-blue-900/50 px-2 py-1 rounded text-xs text-blue-400 border border-blue-500/30">üèÜ <span id="userLevel">Bronze</span></span>
                </div>
            </div>
            <img id="userImg" src="" class="w-12 h-12 rounded-full border-2 border-yellow-500 cursor-pointer" onclick="document.getElementById('termsModal').classList.remove('hidden')">
        </div>

        <div onclick="openSpinWheel()" class="bg-gradient-to-r from-purple-600 to-pink-600 p-3 rounded-xl mb-4 flex justify-between items-center shadow-lg cursor-pointer transform active:scale-95 transition relative overflow-hidden">
            <div>
                <h3 class="font-bold text-white">üé∞ Lucky Spin</h3>
                <p class="text-[10px] text-pink-200">1 Spin per Rs.1000 Deposit</p>
            </div>
            <div id="spinStatusBadge" class="bg-white text-purple-600 px-3 py-1 rounded-full font-bold text-xs">0 Spins</div>
        </div>

        <div class="glass p-6 rounded-3xl mb-4 text-center relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-full bg-green-500/5 z-0"></div>
            <div onclick="openGoalManager()" class="absolute top-3 right-3 bg-gray-800/80 p-2 px-3 rounded-full text-xs cursor-pointer hover:bg-gray-700 z-20 flex items-center gap-1 border border-yellow-500/30 shadow-lg backdrop-blur">
                <span>üéØ</span> <span id="currentGoalName" class="font-bold text-yellow-400">Main Goal</span> <span>‚ñº</span>
            </div>
            <div class="my-4 relative z-10 flex justify-center items-center h-32">
                <div id="treeIcon" class="text-9xl drop-shadow-2xl">üå±</div>
            </div>
            <p class="text-xs text-gray-400 uppercase tracking-widest relative z-10">Saved for this Goal</p>
            <h1 class="text-4xl font-bold text-white relative z-10 mt-1">Rs. <span id="balanceDisplay">0.00</span></h1>
            <p class="text-xs text-gray-500 mt-1 relative z-10">Target: Rs. <span id="targetDisplay">0</span></p>
            <div id="debtDisplayBox" class="hidden mt-3 bg-red-900/40 border border-red-500/50 p-2 rounded-lg inline-block px-4">
                <p class="text-xs text-red-300 font-bold flex items-center gap-2"><span>‚ö†Ô∏è</span> Current Debt: Rs. <span id="debtAmount">0</span></p>
            </div>
        </div>

        <button onclick="requestDeposit()" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-xl shadow-lg mb-4 flex justify-center items-center gap-2 animate-pulse">
            <span>üí∞</span> Deposit Money (Add Funds)
        </button>

        <div class="glass p-4 rounded-2xl mb-4">
            <div class="flex justify-between text-xs text-gray-400 mb-1"><span>Target Progress</span><span id="targetPercentText">0%</span></div>
            <div class="w-full bg-gray-700 rounded-full h-2 mb-3"><div id="targetBar" class="bg-blue-500 h-2 rounded-full" style="width: 0%"></div></div>
            
            <div class="flex justify-between text-xs text-gray-400 mb-1">
                <span>Bonus Status (Over 10k)</span>
                <span id="interestStatus" class="text-[10px]">LOCKED üîí</span>
            </div>
            <div class="w-full bg-gray-700 rounded-full h-2"><div id="moneyBar" class="bg-yellow-600 h-2 rounded-full" style="width: 0%"></div></div>
        </div>

        <div class="glass p-4 rounded-2xl mb-6">
            <h3 class="text-sm font-bold text-yellow-400 mb-3 flex items-center gap-2">üèÜ Top 3 Savers (This Week)</h3>
            <div id="leaderboardList" class="space-y-2"><p class="text-xs text-gray-500 text-center">Loading Ranks...</p></div>
        </div>

        <div class="grid grid-cols-2 gap-3 mb-6">
            <button onclick="openLoanModal()" class="bg-gray-800 border border-blue-500/30 text-blue-400 font-bold py-3 rounded-xl shadow hover:bg-gray-700 flex flex-col items-center justify-center gap-1">
                <span class="text-xl">üí∏</span> <span class="text-xs">Instant Loan</span>
            </button>
            <button onclick="generateCard()" class="bg-gray-800 border border-yellow-500/30 text-yellow-400 font-bold py-3 rounded-xl shadow hover:bg-gray-700 flex flex-col items-center justify-center gap-1">
                <span class="text-xl">ü™™</span> <span class="text-xs">Member Card</span>
            </button>
        </div>
        
        <div class="glass p-4 rounded-2xl border-l-4 border-red-500 relative mb-20">
            <h3 class="font-bold text-gray-200 mb-2">Withdraw</h3>
            <div id="withdrawLock" class="absolute inset-0 bg-gray-900/95 backdrop-blur-sm z-20 flex flex-col items-center justify-center rounded-r-2xl p-4">
                <span class="text-xl mb-1">üîí</span><p class="text-[10px] text-gray-400">Complete Goal to Unlock</p>
            </div>
            <div id="withdrawForm" class="hidden">
                <div class="mb-3">
                    <label class="text-xs text-gray-400 block mb-1">Method:</label>
                    <div class="flex gap-2">
                        <label class="flex-1 cursor-pointer bg-gray-700 p-2 rounded text-center text-xs hover:bg-gray-600"><input type="radio" name="wType" value="cash" checked onclick="toggleWithdrawMethod()" class="mr-1"> Cash üíµ</label>
                        <label class="flex-1 cursor-pointer bg-gray-700 p-2 rounded text-center text-xs hover:bg-gray-600"><input type="radio" name="wType" value="bank" onclick="toggleWithdrawMethod()" class="mr-1"> Bank üè¶</label>
                    </div>
                </div>
                <div id="bankDetailsSection" class="hidden mb-3 space-y-2 bg-gray-800 p-2 rounded border border-gray-600">
                    <input type="text" id="wBankName" placeholder="Bank Name" class="w-full p-2 bg-gray-900 text-white text-xs border border-gray-600 rounded">
                    <input type="text" id="wBranchName" placeholder="Branch Name" class="w-full p-2 bg-gray-900 text-white text-xs border border-gray-600 rounded">
                    <input type="number" id="wAccountNo" placeholder="Account Number" class="w-full p-2 bg-gray-900 text-white text-xs border border-gray-600 rounded">
                </div>
                <input type="number" id="wAmount" placeholder="Amount (Rs)" class="w-full p-2 bg-gray-900 text-white border border-gray-600 rounded mb-3">
                <button onclick="requestWithdraw()" class="w-full bg-red-600 text-white font-bold py-2 rounded text-sm hover:bg-red-700">Request Withdrawal</button>
            </div>
            <div class="h-10 opacity-0"></div>
        </div>
    </div>

    <div id="spinModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/90 p-4">
        <div class="bg-gray-800 rounded-2xl p-6 w-full max-w-sm text-center relative overflow-hidden border border-purple-500">
            <button onclick="document.getElementById('spinModal').classList.add('hidden')" class="absolute top-2 right-4 text-gray-400 text-xl">‚úï</button>
            <h2 class="text-2xl font-bold text-purple-400 mb-2">Lucky Spin üé°</h2>
            <p id="spinsLeftText" class="text-sm text-white font-bold mb-4 bg-purple-900/50 p-2 rounded inline-block">Spins Left: 0</p>
            <div class="relative w-64 h-64 mx-auto mb-6">
                <div id="theWheel" class="wheel w-full h-full rounded-full border-4 border-yellow-500 relative shadow-2xl" 
                     style="background: conic-gradient(#ef4444 0deg 90deg, #3b82f6 90deg 180deg, #22c55e 180deg 270deg, #eab308 270deg 360deg);">
                     <span class="absolute top-10 left-10 text-white font-bold transform -rotate-45">Rs.20</span>
                     <span class="absolute top-10 right-10 text-white font-bold transform rotate-45">Rs.50</span>
                     <span class="absolute bottom-10 right-10 text-white font-bold transform rotate-[135deg]">Rs.100</span>
                     <span class="absolute bottom-10 left-10 text-white font-bold transform rotate-[225deg]">Rs.200</span>
                </div>
                <div class="absolute -top-2 left-1/2 transform -translate-x-1/2 text-3xl text-white">‚ñº</div>
            </div>
            <p id="spinResult" class="text-white font-bold mb-4 h-6"></p>
            <button id="spinBtn" onclick="spinTheWheel()" class="w-full bg-gray-600 text-white font-bold py-3 rounded-xl shadow-lg cursor-not-allowed" disabled>NO SPINS üîí</button>
        </div>
    </div>

    <div id="loanModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/90 p-4">
        <div class="bg-gray-800 rounded-2xl p-6 w-full max-w-sm border border-blue-500">
            <h2 class="text-xl font-bold text-blue-400 mb-2">üí∏ Instant Loan Request</h2>
            <p class="text-gray-400 text-xs mb-4">Up to 50% of TOTAL savings.</p>
            <p class="text-red-400 text-xs mb-4 font-bold">‚ö†Ô∏è Fee: 1% of Loan Amount will be deducted.</p>
            <div class="bg-gray-900 p-3 rounded-lg mb-4">
                <div class="flex justify-between text-sm text-gray-300"><span>Total Savings:</span><span id="loanBaseBalance">Rs. 0</span></div>
                <div class="flex justify-between text-sm text-green-400 font-bold mt-1"><span>Max Loan:</span><span id="maxLoanAmt">Rs. 0</span></div>
            </div>
            <input type="number" id="loanAmountReq" placeholder="Enter Amount" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white mb-4">
            <div class="flex gap-2">
                <button onclick="document.getElementById('loanModal').classList.add('hidden')" class="flex-1 bg-gray-600 py-2 rounded-lg">Cancel</button>
                <button onclick="requestLoan()" class="flex-1 bg-blue-600 py-2 rounded-lg font-bold">Request (WhatsApp)</button>
            </div>
        </div>
    </div>

    <div id="goalModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/90 p-4">
        <div class="bg-gray-800 rounded-2xl p-6 w-full max-w-sm border border-yellow-500">
            <h2 class="text-xl font-bold text-white mb-4">üéØ Your Goals</h2>
            <div id="goalsList" class="space-y-2 mb-4 max-h-40 overflow-y-auto"></div>
            <div class="border-t border-gray-700 pt-4">
                <input type="text" id="newGoalName" placeholder="Goal Name" class="w-full p-2 bg-gray-700 rounded mb-2 text-sm text-white">
                <input type="number" id="newGoalAmount" placeholder="Target (Rs)" class="w-full p-2 bg-gray-700 rounded mb-2 text-sm text-white">
                <button onclick="addNewGoal()" class="w-full bg-green-600 text-white text-sm py-2 rounded font-bold">+ Add Goal</button>
            </div>
            <button onclick="document.getElementById('goalModal').classList.add('hidden')" class="w-full mt-4 text-gray-500 text-xs">Close</button>
        </div>
    </div>

    <div id="termsModal" class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-black/95 p-4">
        <div class="bg-gray-800 rounded-2xl p-6 w-full max-w-sm border border-gray-600">
            <h2 class="text-xl font-bold text-yellow-400 mb-4">üìú Terms & Conditions</h2>
            <div class="h-64 overflow-y-auto text-sm text-gray-300 space-y-3 pr-2">
                <p><strong>1. Savings & Goals:</strong> Withdraw money without penalty only after reaching 100% of Target.</p>
                <p><strong>2. Instant Bonus:</strong> If Balance > 10,000, you get <strong>0.5% Bonus (Rs.5 per 1000)</strong> instantly on every deposit.</p>
                <p><strong>3. Instant Loans:</strong> Max 50% of savings. 1% Fee deducted instantly.</p>
                <p><strong>4. Lucky Spins:</strong> Earn 1 Spin for every Rs. 1000 deposited.</p>
                <p><strong>5. Debt:</strong> Must clear Debt before full withdrawal.</p>
            </div>
            <button onclick="document.getElementById('termsModal').classList.add('hidden')" class="w-full mt-4 bg-gray-700 py-2 rounded font-bold">Close</button>
        </div>
    </div>

    <div id="cardModal" class="hidden fixed inset-0 z-50 flex flex-col items-center justify-center bg-black bg-opacity-95 p-4">
        <h2 class="text-yellow-400 font-bold text-xl mb-4">MEMBERSHIP CARD</h2>
        <canvas id="cardCanvas" width="1000" height="600" class="hidden"></canvas>
        <img id="cardImage" class="w-full max-w-sm rounded-xl shadow-2xl border border-yellow-600 mb-6">
        <a id="downloadLink" class="w-full max-w-sm bg-green-600 text-white font-bold py-3 rounded-xl text-center shadow-lg mb-3">Download üì•</a>
        <button onclick="document.getElementById('cardModal').classList.add('hidden')" class="text-gray-400 text-sm">Close</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDoc, setDoc, doc, onSnapshot, updateDoc, increment, Timestamp, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

        const firebaseConfig = { apiKey: "AIzaSyBQ4b_qLp51HXYJc0Trtp6yG0lO7XSudQk", authDomain: "cnvbankbyuandy.firebaseapp.com", projectId: "cnvbankbyuandy", storageBucket: "cnvbankbyuandy.firebasestorage.app", messagingSenderId: "654524804107", appId: "1:654524804107:web:839811f4eb33b914786b0e" };
        const app = initializeApp(firebaseConfig); const db = getFirestore(app); const auth = getAuth(app); const provider = new GoogleAuthProvider();
        let currentUser = null, userData = null;

        if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; document.getElementById('installPrompt').classList.remove('hidden'); });
        window.installApp = async () => { if(deferredPrompt) { deferredPrompt.prompt(); document.getElementById('installPrompt').classList.add('hidden'); } };

        window.googleLogin = () => signInWithPopup(auth, provider).catch(e => alert(e.message));
        window.logout = () => signOut(auth).then(() => location.reload());

        onAuthStateChanged(auth, async (user) => {
            document.getElementById('loadingView').classList.add('hidden');
            if (user) {
                currentUser = user;
                const userRef = doc(db, "users", user.uid);
                const snap = await getDoc(userRef);
                if (!snap.exists()) {
                    await setDoc(userRef, {
                        name: user.displayName, email: user.email, photo: user.photoURL,
                        balance: 0, streak: 0, debt: 0, availableSpins: 0,
                        accountNo: "CNV"+Math.floor(1000000000+Math.random()*9000000000), 
                        activeGoalIndex: 0, goals: [{ name: "Main Goal", target: 10000, saved: 0 }],
                        lastInterestDate: null
                    });
                    location.reload();
                } else { loadDashboard(snap.data()); }
            } else { document.getElementById('loginView').classList.remove('hidden'); }
        });

        function loadDashboard(data) {
            document.getElementById('loginView').classList.add('hidden');
            document.getElementById('dashboardView').classList.remove('hidden');
            document.getElementById('userName').innerText = data.name.split(" ")[0];
            document.getElementById('userImg').src = data.photo;
            loadLeaderboard();

            onSnapshot(doc(db, "users", currentUser.uid), (docSnap) => {
                userData = docSnap.data();
                
                const goals = userData.goals || [{name:"Main Goal", target:10000, saved: 0}];
                const activeIdx = (userData.activeGoalIndex !== undefined) ? userData.activeGoalIndex : 0;
                const currentGoal = goals[activeIdx] || goals[0];
                const currentBalance = currentGoal.saved || 0;
                let totalGlobalBalance = 0; goals.forEach(g => totalGlobalBalance += (g.saved || 0));

                document.getElementById('currentGoalName').innerText = currentGoal.name;
                document.getElementById('balanceDisplay').innerText = currentBalance.toFixed(2);
                document.getElementById('targetDisplay').innerText = currentGoal.target;
                document.getElementById('streakCount').innerText = userData.streak || 0;

                if(userData.debt > 0) {
                    document.getElementById('debtDisplayBox').classList.remove('hidden');
                    document.getElementById('debtAmount').innerText = userData.debt;
                } else { document.getElementById('debtDisplayBox').classList.add('hidden'); }

                const moneyPct = Math.min((totalGlobalBalance / 10000) * 100, 100);
                document.getElementById('moneyBar').style.width = `${moneyPct}%`;
                const intStatus = document.getElementById('interestStatus');
                if(totalGlobalBalance >= 10000) {
                    document.getElementById('moneyBar').classList.add('bg-green-500');
                    intStatus.innerText = "Bonus Active ‚úÖ (0.5% on Dep)"; intStatus.className = "text-[10px] text-green-400 font-bold";
                } else {
                    document.getElementById('moneyBar').classList.remove('bg-green-500');
                    intStatus.innerText = "LOCKED üîí (Reach 10k)"; intStatus.className = "text-[10px] text-gray-400";
                }

                let level = "Bronze"; if(totalGlobalBalance > 10000) level = "Silver"; if(currentBalance > currentGoal.target) level = "Gold";
                document.getElementById('userLevel').innerText = level;

                const pct = (currentBalance / currentGoal.target) * 100;
                document.getElementById('targetBar').style.width = `${Math.min(pct,100)}%`;
                document.getElementById('targetPercentText').innerText = `${pct.toFixed(1)}%`;

                let tree = "üå±"; if(pct>20) tree="üåø"; if(pct>50) tree="üå≥"; if(pct>80) tree="üå≤"; if(pct>=100) tree="üéÑ";
                document.getElementById('treeIcon').innerText = tree;

                if(currentBalance >= currentGoal.target && currentBalance > 0) {
                    document.getElementById('withdrawLock').classList.add('hidden'); document.getElementById('withdrawForm').classList.remove('hidden');
                } else {
                    document.getElementById('withdrawLock').classList.remove('hidden'); document.getElementById('withdrawForm').classList.add('hidden');
                }

                const spinCount = userData.availableSpins || 0;
                const badge = document.getElementById('spinStatusBadge');
                badge.innerText = `${spinCount} Spins`;
                if(spinCount > 0) {
                    badge.classList.replace('text-purple-600', 'text-green-600');
                } else {
                    badge.classList.replace('text-green-600', 'text-purple-600');
                }
            });
        }

        function loadLeaderboard() {
            onSnapshot(collection(db, "users"), (snap) => {
                let users = [];
                snap.forEach(d => {
                    const u = d.data();
                    const goals = u.goals || [{target:100000, saved:0}];
                    let totalSaved = 0, totalTarget = 0;
                    goals.forEach(g => { totalSaved += (g.saved||0); totalTarget += (g.target||100000); });
                    const pct = totalTarget > 0 ? (totalSaved / totalTarget) * 100 : 0;
                    users.push({ name: u.name, photo: u.photo, pct: pct, uid: d.id });
                });
                users.sort((a, b) => b.pct - a.pct);
                const top3 = users.slice(0, 3);
                const list = document.getElementById('leaderboardList');
                list.innerHTML = "";
                top3.forEach((u, i) => {
                    const isMe = u.uid === currentUser.uid;
                    const rankClass = i === 0 ? "rank-1" : (i === 1 ? "rank-2" : "rank-3");
                    list.innerHTML += `<div class="flex items-center justify-between bg-gray-800 p-2 rounded-lg border border-gray-700 ${isMe ? 'border-yellow-500' : ''}"><div class="flex items-center gap-3"><div class="w-6 h-6 rounded-full flex items-center justify-center font-bold text-xs ${rankClass}">${i+1}</div><img src="${u.photo}" class="w-8 h-8 rounded-full border border-gray-600"><p class="text-sm font-bold text-gray-200">${isMe ? 'You' : u.name.split(" ")[0]}</p></div><div class="text-right"><p class="text-xs font-bold text-green-400">${u.pct.toFixed(1)}%</p></div></div>`;
                });
            });
        }

        window.requestDeposit = async () => {
            const amount = prompt("Enter Amount to Deposit (Rs):");
            if(amount && !isNaN(amount) && parseFloat(amount) > 0) {
                const req = parseFloat(amount);
                const msg = `üîî *New Deposit Request*\n\nüë§ User: ${userData.name}\nüí∞ Amount: Rs. ${req}\n\nPlease collect & approve in Admin.`;
                window.open(`https://wa.me/94726284277?text=${encodeURIComponent(msg)}`, '_blank');
            } else if (amount) { alert("Invalid Amount!"); }
        };

        window.openSpinWheel = () => {
            const spins = userData.availableSpins || 0;
            document.getElementById('spinsLeftText').innerText = `Spins Left: ${spins}`;
            const btn = document.getElementById('spinBtn');
            if(spins > 0) {
                btn.disabled = false; btn.innerText = "SPIN NOW!"; btn.classList.remove('bg-gray-600', 'cursor-not-allowed'); btn.classList.add('bg-gradient-to-r', 'from-purple-600', 'to-pink-600');
            } else {
                btn.disabled = true; btn.innerText = "NO SPINS üîí"; btn.classList.add('bg-gray-600', 'cursor-not-allowed'); btn.classList.remove('bg-gradient-to-r');
            }
            document.getElementById('spinModal').classList.remove('hidden');
        };

        window.spinTheWheel = async () => {
            if((userData.availableSpins || 0) <= 0) return;
            const btn = document.getElementById('spinBtn'); btn.disabled = true; 
            const wheel = document.getElementById('theWheel');
            const prizes = [20, 50, 100, 200]; const prize = prizes[Math.floor(Math.random() * prizes.length)];
            
            let targetAngle = 0;
            if (prize === 20) targetAngle = 45; else if (prize === 50) targetAngle = 315; else if (prize === 100) targetAngle = 225; else if (prize === 200) targetAngle = 135;
            const rot = (360 * 8) + targetAngle + Math.floor(Math.random() * 20 - 10);
            wheel.style.transform = `rotate(${rot}deg)`;

            setTimeout(async () => {
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                document.getElementById('spinResult').innerText = `You won Rs. ${prize}!`;
                const goals = userData.goals; const idx = userData.activeGoalIndex || 0;
                if(!goals[idx].saved) goals[idx].saved = 0; goals[idx].saved += prize;
                await updateDoc(doc(db, "users", currentUser.uid), { goals: goals, balance: increment(prize), availableSpins: increment(-1) });
                await addDoc(collection(db, "transactions"), { userId: currentUser.uid, userName: userData.name, type: "spin_win", amount: prize, status: "success", date: new Date() });
                setTimeout(() => { document.getElementById('spinModal').classList.add('hidden'); wheel.style.transform = 'rotate(0deg)'; document.getElementById('spinResult').innerText = ""; }, 2000);
            }, 4000);
        };

        window.openLoanModal = () => {
            let totalBal = 0; (userData.goals || []).forEach(g => totalBal += (g.saved || 0));
            const max = totalBal * 0.5;
            document.getElementById('loanBaseBalance').innerText = `Rs. ${totalBal.toFixed(2)}`;
            document.getElementById('maxLoanAmt').innerText = `Rs. ${max.toFixed(2)}`;
            document.getElementById('loanModal').classList.remove('hidden');
        };

        window.requestLoan = async () => {
            const req = parseFloat(document.getElementById('loanAmountReq').value);
            let totalBal = 0; const goals = userData.goals || []; goals.forEach(g => totalBal += (g.saved || 0));
            if(!req || req <= 0) return alert("Enter amount");
            if(req > (totalBal * 0.5)) return alert("Limit Exceeded!");
            const fee = req * 0.01; 
            if(confirm(`Request Loan of Rs. ${req}?\n\nA Fee of Rs. ${fee} (1%) will be deducted.`)) {
                const idx = userData.activeGoalIndex || 0;
                if(goals[idx].saved >= fee) { goals[idx].saved -= fee; } else { goals[0].saved -= fee; }
                await updateDoc(doc(db, "users", currentUser.uid), { goals: goals, balance: increment(-fee) });
                await addDoc(collection(db, "transactions"), { userId: currentUser.uid, userName: userData.name, type: "loan_request", amount: req, status: "pending", date: new Date(), feeDetails: `1% Fee (Rs.${fee}) Paid` });
                const msg = `üîî *New Loan Request*\n\nüë§ User: ${userData.name}\nüí∞ Loan Amount: Rs. ${req}\nüìâ Fee Paid: Rs. ${fee}\nüè¶ Total Savings: Rs. ${totalBal}\n\nPlease approve in Admin Panel.`;
                window.open(`https://wa.me/94726284277?text=${encodeURIComponent(msg)}`, '_blank');
                document.getElementById('loanModal').classList.add('hidden');
            }
        };

        window.toggleWithdrawMethod = () => {
            const method = document.querySelector('input[name="wType"]:checked').value;
            const bankDiv = document.getElementById('bankDetailsSection');
            if (method === 'bank') bankDiv.classList.remove('hidden'); else bankDiv.classList.add('hidden');
        };

        window.requestWithdraw = async () => {
            const amount = parseFloat(document.getElementById('wAmount').value);
            if (!amount || amount <= 0) return alert("Enter valid amount!");
            const currentGoalName = userData.goals[userData.activeGoalIndex || 0].name;
            const method = document.querySelector('input[name="wType"]:checked').value;
            let details = "Cash Withdrawal"; let bankMsgPart = "";
            if (method === 'bank') {
                const bank = document.getElementById('wBankName').value; const branch = document.getElementById('wBranchName').value; const acc = document.getElementById('wAccountNo').value;
                if (!bank || !branch || !acc) return alert("Please fill details!");
                details = `Bank: ${bank} | Branch: ${branch} | Acc: ${acc}`;
                bankMsgPart = `\nüè¶ Bank: ${bank}\nüìç Branch: ${branch}\nüî¢ Acc: ${acc}`;
            }
            if(confirm("Confirm Withdrawal?")) {
                await addDoc(collection(db, "transactions"), { userId: currentUser.uid, userName: userData.name, type: "withdraw", amount: amount, status: "pending", date: new Date(), method: method, details: details, targetGoal: currentGoalName });
                const msg = `üîî *New Withdrawal Request*\n\nüë§ User: ${userData.name}\nüí∞ Amount: Rs. ${amount}\nüéØ From Goal: ${currentGoalName}\nüìÇ Method: ${method.toUpperCase()}${bankMsgPart}\n\nPlease check Admin Panel.`;
                window.open(`https://wa.me/94726284277?text=${encodeURIComponent(msg)}`, '_blank');
                alert("Requested!"); document.getElementById('wAmount').value = "";
            }
        };

        window.openGoalManager = () => { document.getElementById('goalModal').classList.remove('hidden'); renderGoals(); };
        function renderGoals() {
            const list = document.getElementById('goalsList'); list.innerHTML = "";
            const goals = userData.goals || [];
            goals.forEach((g, idx) => {
                const isActive = idx === (userData.activeGoalIndex || 0);
                const bg = isActive ? "bg-green-900 border-green-500" : "bg-gray-700 border-gray-600";
                list.innerHTML += `<div onclick="switchGoal(${idx})" class="${bg} p-3 rounded-lg border flex justify-between items-center cursor-pointer hover:opacity-80"><div><p class="font-bold text-sm text-white">${g.name}</p><p class="text-xs text-gray-400">Saved: Rs.${g.saved||0} / ${g.target}</p></div>${isActive?'‚úÖ':''}</div>`;
            });
        }
        window.addNewGoal = async () => {
            const name = document.getElementById('newGoalName').value; const target = parseFloat(document.getElementById('newGoalAmount').value);
            if(!name || !target) return;
            const newGoals = [...(userData.goals || []), { name, target, saved: 0 }];
            await updateDoc(doc(db, "users", currentUser.uid), { goals: newGoals });
            document.getElementById('newGoalName').value = ""; document.getElementById('newGoalAmount').value = ""; renderGoals();
        };
        window.switchGoal = async (idx) => { await updateDoc(doc(db, "users", currentUser.uid), { activeGoalIndex: idx }); renderGoals(); };

        window.generateCard = () => {
            const canvas = document.getElementById('cardCanvas'); const ctx = canvas.getContext('2d'); const u = userData;
            const grad = ctx.createLinearGradient(0, 0, 1000, 600); grad.addColorStop(0, '#000000'); grad.addColorStop(0.4, '#1a1a1a'); grad.addColorStop(1, '#2c2c2c'); ctx.fillStyle = grad; ctx.fillRect(0, 0, 1000, 600); ctx.strokeStyle = '#eab308'; ctx.lineWidth = 15; ctx.strokeRect(20, 20, 960, 560);
            ctx.font = 'bold 50px sans-serif'; ctx.fillStyle = '#eab308'; ctx.fillText('CNV SUPER SAVER', 60, 100); ctx.fillStyle = '#d4af37'; ctx.fillRect(60, 200, 120, 100);
            const acc = u.accountNo || "CNV0000000000"; ctx.font = 'bold 70px monospace'; ctx.fillStyle = '#ffffff'; ctx.fillText(acc.replace(/(.{4})/g, '$1 '), 60, 420);
            ctx.font = '40px sans-serif'; ctx.fillStyle = '#eab308'; ctx.fillText(u.name.toUpperCase(), 60, 520);
            const dataUrl = canvas.toDataURL("image/png"); document.getElementById('cardImage').src = dataUrl; document.getElementById('downloadLink').href = dataUrl; document.getElementById('downloadLink').download = `CNV_Card.png`; document.getElementById('cardModal').classList.remove('hidden');
        };
    </script>
</body>
</html>
