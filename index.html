<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CNV Bank - Pro System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Sinhala:wght@400;700&display=swap');
        body { font-family: 'Noto Sans Sinhala', sans-serif; overflow-x: hidden; }
        #canvas-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: linear-gradient(to bottom, #0f172a, #1e3a8a); }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        /* Image Preview Style */
        .image-preview { width: 100%; height: 150px; object-fit: cover; border-radius: 8px; display: none; margin-top: 10px; border: 2px dashed #cbd5e1; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <div id="canvas-container"></div>

    <div id="loginView" class="flex-1 flex flex-col justify-center items-center p-4 min-h-screen">
        <div class="glass p-8 rounded-2xl shadow-2xl max-w-sm w-full text-center border border-white/50">
            <h1 class="text-3xl font-bold text-blue-900 mb-2">CNV BANK üè¶</h1>
            <p class="text-gray-500 mb-8">Secure & Smart Banking</p>
            
            <button onclick="googleLogin()" class="w-full flex items-center justify-center gap-3 bg-white border border-gray-200 p-4 rounded-xl shadow-md hover:bg-gray-50 transition transform active:scale-95">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-6 h-6">
                <span class="font-bold text-gray-700">Google Login</span>
            </button>
        </div>
        
        <button onclick="openAdmin()" class="mt-10 text-white/50 text-sm hover:text-white underline">
            Go to Admin Panel ‚ûî
        </button>
    </div>

    <div id="setupView" class="hidden min-h-screen flex flex-col justify-center items-center p-4">
        <div class="glass p-6 rounded-2xl shadow-2xl max-w-md w-full border-l-4 border-yellow-500">
            <h2 class="text-xl font-bold text-gray-800 mb-2">‡∂ú‡∑í‡∂´‡∑î‡∂∏ ‡∑É‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫ ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏ ‚ö†Ô∏è</h2>
            <p class="text-sm text-gray-600 mb-4">‡∂â‡∂Ø‡∑í‡∂ª‡∑í‡∂∫‡∂ß ‡∂∫‡∑è‡∂∏‡∂ß ‡∂î‡∂∂‡∂ú‡∑ö ‡∂∂‡∑ê‡∂Ç‡∂ö‡∑î ‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª ‡∑É‡∑Ñ ‡∑Ñ‡∑ê‡∂≥‡∑î‡∂±‡∑î‡∂∏‡∑ä‡∂¥‡∂≠ ‡∂Ω‡∂∂‡∑è ‡∂Ø‡∑í‡∂∫ ‡∂∫‡∑î‡∂≠‡∑î‡∂∫.</p>

            <label class="block text-sm font-bold text-gray-700 mt-3">‡∂î‡∂∂‡∑ö ‡∂∂‡∑ê‡∂Ç‡∂ö‡∑î‡∑Ä‡∑ö ‡∂±‡∂∏</label>
            <input type="text" id="regBankName" placeholder="‡∂ã‡∂Ø‡∑è: BOC / Commercial" class="w-full p-2 border rounded bg-gray-50">

            <label class="block text-sm font-bold text-gray-700 mt-3">‡∂ú‡∑í‡∂´‡∑î‡∂∏‡∑ä ‡∂Ö‡∂Ç‡∂ö‡∂∫ (Account No)</label>
            <input type="number" id="regAccNo" placeholder="Account Number" class="w-full p-2 border rounded bg-gray-50">

            <label class="block text-sm font-bold text-gray-700 mt-3">NIC ‡∑Ü‡∑ú‡∂ß‡∑ù ‡∂ë‡∂ö (‡∂â‡∂Ø‡∑í‡∂ª‡∑í‡∂¥‡∑É)</label>
            <input type="file" id="regNicFile" accept="image/*" class="w-full text-sm text-gray-500 mt-1" onchange="previewImage(this)">
            <img id="nicPreview" class="image-preview">
            
            <button onclick="completeProfile()" id="saveProfileBtn" class="w-full bg-blue-700 text-white p-3 rounded-xl font-bold mt-6 shadow hover:bg-blue-800">
                ‡∂≠‡∑ú‡∂ª‡∂≠‡∑î‡∂ª‡∑î ‡∂≠‡∑Ñ‡∑Ä‡∑î‡∂ª‡∑î ‡∂ö‡∂ª‡∂±‡∑ä‡∂± ‚úÖ
            </button>
        </div>
    </div>

    <div id="dashboardView" class="hidden flex-col min-h-screen p-4 max-w-md mx-auto w-full relative z-10">
        <div class="bg-gradient-to-r from-blue-600 to-indigo-800 p-6 rounded-3xl text-white shadow-xl mb-6">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-blue-200 text-xs uppercase tracking-wider">Total Balance</p>
                    <h1 class="text-4xl font-bold mt-1">Rs. <span id="userBalance">0.00</span></h1>
                </div>
                <img id="userPhoto" src="" class="w-12 h-12 rounded-full border-2 border-white/50">
            </div>
            <p class="mt-4 text-sm font-medium">Hello, <span id="displayName">User</span> üëã</p>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-6">
            <button onclick="toggleSection('depositBox')" class="bg-white p-5 rounded-2xl shadow-lg hover:shadow-xl transition active:scale-95 text-center">
                <div class="text-3xl mb-1">üì•</div>
                <div class="font-bold text-gray-700">‡∂≠‡∑ê‡∂±‡∑ä‡∂¥‡∂≠‡∑ä</div>
            </button>
            <button onclick="toggleSection('withdrawBox')" class="bg-white p-5 rounded-2xl shadow-lg hover:shadow-xl transition active:scale-95 text-center">
                <div class="text-3xl mb-1">üì§</div>
                <div class="font-bold text-gray-700">‡∂ú‡∑ê‡∂±‡∑ì‡∂∏‡∑ä</div>
            </button>
        </div>

        <div id="depositBox" class="hidden glass p-5 rounded-2xl shadow-lg mb-4 border-l-4 border-green-500 animate-fade-in">
            <div class="bg-blue-50 p-4 rounded-xl border border-blue-200 text-center mb-4">
                <h3 class="text-blue-800 font-bold text-lg">COMMERCIAL BANK</h3>
                <p class="text-xs text-gray-500">Kurunegala Branch</p>
                <p class="text-sm font-bold text-gray-700 mt-2">K M H Y S Kariyawasam</p>
                
                <div class="flex items-center justify-center gap-2 mt-1 bg-white p-2 rounded border border-blue-100">
                    <span class="text-xl font-bold text-gray-800 tracking-wider">8025211913</span>
                    <button onclick="navigator.clipboard.writeText('8025211913'); alert('Copied!');" class="text-xs bg-gray-200 p-1 rounded">üìã Copy</button>
                </div>
                
                <a href="https://www.combankdigital.com/" target="_blank" class="block w-full bg-blue-600 text-white py-2 rounded-lg font-bold mt-3 text-sm hover:bg-blue-700">
                    Open ComBank App üè¶
                </a>
            </div>

            <h3 class="font-bold text-gray-800 mb-2">Step 2: Slip ‡∂ë‡∂ö ‡∂ë‡∑Ä‡∂±‡∑ä‡∂±</h3>
            <input type="number" id="depositAmount" placeholder="‡∂≠‡∑ê‡∂±‡∑ä‡∂¥‡∂≠‡∑ä ‡∂ö‡∑Ö ‡∂∏‡∑î‡∂Ø‡∂Ω (Rs)" class="w-full p-3 border rounded-xl mb-3 text-center font-bold">
            <button onclick="requestDeposit()" class="w-full bg-green-600 text-white p-3 rounded-xl font-bold shadow-lg">‡∂â‡∂Ω‡∑ä‡∂Ω‡∑ì‡∂∏ ‡∂∫‡∑Ä‡∂±‡∑ä‡∂±</button>
        </div>

        <div id="withdrawBox" class="hidden glass p-5 rounded-2xl shadow-lg mb-4 border-l-4 border-red-500 animate-fade-in">
            <h3 class="font-bold text-gray-800 mb-2">‡∂∏‡∑î‡∂Ø‡∂Ω‡∑ä ‡∂Ü‡∂¥‡∑É‡∑î ‡∂ú‡∑ê‡∂±‡∑ì‡∂∏</h3>
            <p class="text-xs text-gray-500 mb-3">‡∂î‡∂∂‡∑ö ‡∂∂‡∑ê‡∂Ç‡∂ö‡∑î ‡∂ú‡∑í‡∂´‡∑î‡∂∏‡∂ß ‡∂∏‡∑î‡∂Ø‡∂Ω‡∑ä ‡∂ë‡∑Ä‡∂±‡∑î ‡∂Ω‡∑ê‡∂∂‡∑ö.</p>
            
            <input type="number" id="withdrawAmount" placeholder="‡∂ú‡∂±‡∑ä‡∂±‡∑è ‡∂∏‡∑î‡∂Ø‡∂Ω (Rs)" class="w-full p-3 border rounded-xl mb-3 text-center font-bold">
            <button onclick="requestWithdraw()" class="w-full bg-red-600 text-white p-3 rounded-xl font-bold shadow-lg">WhatsApp ‡∂â‡∂Ω‡∑ä‡∂Ω‡∑ì‡∂∏ ‡∂∫‡∑Ä‡∂±‡∑ä‡∂±</button>
        </div>

        <button onclick="logout()" class="w-full bg-gray-200 text-gray-700 p-3 rounded-xl font-bold mt-auto">Logout</button>
    </div>

    <div id="adminView" class="hidden min-h-screen bg-slate-900 text-white p-4">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold text-yellow-400">üëë ADMIN PANEL</h1>
            <button onclick="location.reload()" class="bg-red-600 px-3 py-1 rounded text-sm font-bold">EXIT</button>
        </div>

        <div class="grid grid-cols-1 gap-4">
            <div class="bg-slate-800 p-4 rounded-xl border border-slate-700">
                <h2 class="text-lg font-bold mb-4 border-b border-slate-600 pb-2">Pending Requests</h2>
                <div id="adminList" class="space-y-3">
                    <p class="text-slate-500 text-center">Loading...</p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDoc, setDoc, doc, onSnapshot, query, where, updateDoc, increment } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBQ4b_qLp51HXYJc0Trtp6yG0lO7XSudQk",
            authDomain: "cnvbankbyuandy.firebaseapp.com",
            projectId: "cnvbankbyuandy",
            storageBucket: "cnvbankbyuandy.firebasestorage.app",
            messagingSenderId: "654524804107",
            appId: "1:654524804107:web:839811f4eb33b914786b0e",
            measurementId: "G-PWWVKS8EEM"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let userData = null;
        const ADMIN_WHATSAPP = "94726284277";

        // --- NAVIGATION ---
        window.showView = (id) => {
            ['loginView', 'setupView', 'dashboardView', 'adminView'].forEach(v => document.getElementById(v).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        };

        window.toggleSection = (id) => {
            document.getElementById('depositBox').classList.add('hidden');
            document.getElementById('withdrawBox').classList.add('hidden');
            document.getElementById(id).classList.remove('hidden');
        };

        // --- 1. AUTH FLOW ---
        window.googleLogin = () => {
            signInWithPopup(auth, provider).catch(err => alert("Login Error: " + err.message));
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const userRef = doc(db, "users", user.uid);
                const userSnap = await getDoc(userRef);

                if (!userSnap.exists()) {
                    // Create base doc but incomplete
                    await setDoc(userRef, {
                        name: user.displayName,
                        email: user.email,
                        photo: user.photoURL,
                        balance: 0,
                        profileComplete: false
                    });
                    showView('setupView'); // Go to setup
                } else {
                    const data = userSnap.data();
                    if (!data.profileComplete) {
                        showView('setupView'); // Profile incomplete
                    } else {
                        // Profile Complete -> Go to Dashboard
                        userData = data;
                        loadDashboard();
                    }
                }
            } else {
                showView('loginView');
            }
        });

        // --- 2. PROFILE SETUP (Base64 Image) ---
        let nicBase64 = "";

        window.previewImage = (input) => {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const img = document.getElementById('nicPreview');
                    img.src = e.target.result;
                    img.style.display = 'block';
                    
                    // Compress for Firestore (Basic Canvas compression)
                    const image = new Image();
                    image.src = e.target.result;
                    image.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const maxWidth = 600; // Resize to max 600px width
                        const scaleSize = maxWidth / image.width;
                        canvas.width = maxWidth;
                        canvas.height = image.height * scaleSize;
                        ctx.drawImage(image, 0, 0, canvas.width, canvas.height);
                        nicBase64 = canvas.toDataURL('image/jpeg', 0.7); // 70% quality
                    };
                };
                reader.readAsDataURL(input.files[0]);
            }
        };

        window.completeProfile = async () => {
            const bankName = document.getElementById('regBankName').value;
            const accNo = document.getElementById('regAccNo').value;
            const btn = document.getElementById('saveProfileBtn');

            if(!bankName || !accNo || !nicBase64) return alert("‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∑É‡∑í‡∂∫‡∂Ω‡∑î ‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª ‡∑É‡∑Ñ NIC ‡∑Ü‡∑ú‡∂ß‡∑ù ‡∂ë‡∂ö ‡∂Ω‡∂∂‡∑è ‡∂Ø‡∑ô‡∂±‡∑ä‡∂±.");

            btn.innerText = "Saving...";
            try {
                await updateDoc(doc(db, "users", currentUser.uid), {
                    bankDetails: `${bankName} - ${accNo}`,
                    nicImage: nicBase64,
                    profileComplete: true
                });
                alert("‡∂ú‡∑í‡∂´‡∑î‡∂∏ ‡∑É‡∂ö‡∑É‡∑è ‡∂Ö‡∑Ä‡∑É‡∂±‡∑ä! ‚úÖ");
                location.reload();
            } catch(e) {
                alert("Error: " + e.message);
                btn.innerText = "Try Again";
            }
        };

        // --- 3. DASHBOARD LOGIC ---
        function loadDashboard() {
            showView('dashboardView');
            document.getElementById('displayName').innerText = currentUser.displayName.split(" ")[0];
            document.getElementById('userPhoto').src = currentUser.photoURL;

            onSnapshot(doc(db, "users", currentUser.uid), (doc) => {
                userData = doc.data(); // Keep local data sync
                document.getElementById('userBalance').innerText = userData.balance.toFixed(2);
            });
        }

        window.requestDeposit = async () => {
            const amount = parseFloat(document.getElementById('depositAmount').value);
            if (!amount) return alert("‡∂∏‡∑î‡∂Ø‡∂Ω ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±");

            await addDoc(collection(db, "transactions"), {
                userId: currentUser.uid,
                userName: currentUser.displayName,
                type: "deposit",
                amount: amount,
                status: "pending",
                date: new Date()
            });
            alert("‡∂≠‡∑ê‡∂±‡∑ä‡∂¥‡∂≠‡∑î ‡∂â‡∂Ω‡∑ä‡∂Ω‡∑ì‡∂∏ ‡∂∫‡∑ê‡∑Ä‡∑ä‡∑Ä‡∑è! Admin ‡∂Ö‡∂±‡∑î‡∂∏‡∂≠ ‡∂ö‡∂ª‡∂±‡∂≠‡∑î‡∂ª‡∑î ‡∑É‡∑í‡∂ß‡∑í‡∂±‡∑ä‡∂±.");
            document.getElementById('depositAmount').value = "";
            document.getElementById('depositBox').classList.add('hidden');
        };

        window.requestWithdraw = async () => {
            const amount = parseFloat(document.getElementById('withdrawAmount').value);
            if (!amount) return alert("‡∂∏‡∑î‡∂Ø‡∂Ω ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±");

            // Save to DB
            await addDoc(collection(db, "transactions"), {
                userId: currentUser.uid,
                userName: currentUser.displayName,
                userBank: userData.bankDetails, // Include Bank Details in DB Record
                type: "withdraw",
                amount: amount,
                status: "pending",
                date: new Date()
            });

            // Format Message for WhatsApp with Bank Details
            const msg = `CNV Bank Withdraw:%0Aüë§ ${currentUser.displayName}%0Aüí∏ Amount: Rs. ${amount}%0Aüè¶ To Bank: ${userData.bankDetails}%0Aüïí Request Time: ${new Date().toLocaleTimeString()}`;
            
            window.open(`https://wa.me/${ADMIN_WHATSAPP}?text=${msg}`, '_blank');
            document.getElementById('withdrawBox').classList.add('hidden');
        };

        window.logout = () => signOut(auth).then(() => location.reload());

        // --- 4. ADMIN PANEL (No Password) ---
        window.openAdmin = () => {
            showView('adminView');
            loadAdminData();
        };

        function loadAdminData() {
            const q = query(collection(db, "transactions"), where("status", "==", "pending"));
            onSnapshot(q, (snap) => {
                const list = document.getElementById('adminList');
                list.innerHTML = "";
                if(snap.empty) list.innerHTML = "<p class='text-gray-400 text-center'>No Requests.</p>";

                snap.forEach(d => {
                    const t = d.data();
                    const isDep = t.type === 'deposit';
                    
                    // Show Bank Details if it's a withdraw request
                    const bankInfo = !isDep && t.userBank ? `<p class="text-xs text-yellow-300 mt-1">üè¶ ${t.userBank}</p>` : '';
                    
                    list.innerHTML += `
                        <div class="flex justify-between items-center bg-slate-700 p-3 rounded border-l-4 ${isDep ? 'border-green-500' : 'border-red-500'}">
                            <div>
                                <p class="font-bold text-white">${t.userName}</p>
                                <p class="text-xs text-slate-400 uppercase">${t.type}</p>
                                ${bankInfo}
                            </div>
                            <div class="text-right">
                                <p class="font-bold text-xl text-white">Rs. ${t.amount}</p>
                                <button onclick="processTx('${d.id}', '${t.userId}', ${t.amount}, '${t.type}')" class="bg-blue-600 px-3 py-1 rounded text-xs font-bold mt-1">APPROVE</button>
                            </div>
                        </div>
                    `;
                });
            });
        }

        window.processTx = async (txId, userId, amount, type) => {
            if(!confirm("Approve this transaction?")) return;
            const adjustment = type === 'deposit' ? amount : -amount;

            try {
                await updateDoc(doc(db, "transactions", txId), { status: "success" });
                await updateDoc(doc(db, "users", userId), { balance: increment(adjustment) });
            } catch(e) { alert(e.message); }
        };

    </script>

    <script>
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        const geo = new THREE.BufferGeometry();
        const count = 500;
        const pos = new Float32Array(count * 3);
        for(let i=0; i<count*3; i++) pos[i] = (Math.random()-0.5) * 10;
        geo.setAttribute('position', new THREE.BufferAttribute(pos, 3));
        const mat = new THREE.PointsMaterial({ size: 0.05, color: 0x4f46e5 });
        const mesh = new THREE.Points(geo, mat);
        scene.add(mesh);
        camera.position.z = 5;

        function animate() {
            requestAnimationFrame(animate);
            mesh.rotation.y += 0.002;
            renderer.render(scene, camera);
        }
        animate();
    </script>
</body>
</html>
