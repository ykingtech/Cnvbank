<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CNV Super Saver</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Sinhala:wght@400;700&display=swap');
        body { font-family: 'Noto Sans Sinhala', sans-serif; background: #0f172a; color: white; }
        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        
        /* Tree Animation */
        .tree-container { transition: all 1s ease-in-out; }
        @keyframes grow { 0% { transform: scale(0.8); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        .grow-anim { animation: grow 2s infinite ease-in-out; }
    </style>
</head>
<body class="min-h-screen pb-20">

    <div id="loginView" class="flex flex-col justify-center items-center min-h-screen p-4">
        <h1 class="text-4xl font-bold text-yellow-400 mb-2 tracking-wider">SUPER SAVER üèÜ</h1>
        <button onclick="googleLogin()" class="bg-white text-gray-900 px-6 py-3 rounded-full font-bold shadow-lg flex items-center gap-3 mt-8 hover:scale-105 transition">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-6 h-6">
            Google Login
        </button>
    </div>

    <div id="dashboardView" class="hidden p-4 max-w-md mx-auto">
        <div class="flex justify-between items-center mb-4">
            <div>
                <h2 class="text-xl font-bold" id="userName">User</h2>
                <div class="flex items-center gap-1 bg-orange-900/50 px-2 py-1 rounded-lg border border-orange-500/30 mt-1">
                    <span class="text-lg">üî•</span>
                    <span id="streakCount" class="text-orange-400 font-bold text-sm">0 Days Streak!</span>
                </div>
            </div>
            <img id="userImg" src="" class="w-12 h-12 rounded-full border-2 border-yellow-500">
        </div>

        <div class="flex justify-between gap-2 mb-4 bg-gray-800 p-2 rounded-xl">
            <div id="badgeBronze" class="opacity-30 grayscale flex flex-col items-center w-1/3">
                <span class="text-2xl">ü•â</span>
                <span class="text-[10px] text-gray-400">Bronze (5k)</span>
            </div>
            <div id="badgeSilver" class="opacity-30 grayscale flex flex-col items-center w-1/3 border-l border-r border-gray-700">
                <span class="text-2xl">ü•à</span>
                <span class="text-[10px] text-gray-400">Silver (10k)</span>
            </div>
            <div id="badgeGold" class="opacity-30 grayscale flex flex-col items-center w-1/3">
                <span class="text-2xl">ü•á</span>
                <span class="text-[10px] text-gray-400">Gold (Goal)</span>
            </div>
        </div>

        <div class="glass p-6 rounded-3xl mb-6 text-center relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-full bg-green-500/5 z-0"></div>
            <p class="text-xs text-green-300 uppercase tracking-widest relative z-10">My Savings Tree</p>
            
            <div class="my-4 relative z-10 flex justify-center items-center h-32">
                <div id="treeIcon" class="text-9xl drop-shadow-2xl tree-container">üå±</div>
            </div>
            
            <h1 class="text-3xl font-bold text-white relative z-10">Rs. <span id="balanceDisplay">0.00</span></h1>
            <p class="text-xs text-gray-400 mt-1 relative z-10">Target: Rs. <span id="targetDisplay">0</span></p>
        </div>

        <div class="glass p-4 rounded-2xl mb-6">
            <div class="flex justify-between text-xs text-gray-400 mb-1">
                <span>Target Progress</span>
                <span id="targetPercentText">0%</span>
            </div>
            <div class="w-full bg-gray-700 rounded-full h-3 mb-4">
                <div id="targetBar" class="bg-gradient-to-r from-blue-500 to-cyan-400 h-3 rounded-full transition-all duration-1000" style="width: 0%"></div>
            </div>

            <div class="flex justify-between text-xs text-gray-400 mb-1">
                <span>Monetization (Unlock Interest)</span>
                <span id="moneyPercentText">0%</span>
            </div>
            <div class="w-full bg-gray-700 rounded-full h-3">
                <div id="moneyBar" class="bg-yellow-600 h-3 rounded-full transition-all duration-1000" style="width: 0%"></div>
            </div>
            <p id="interestStatus" class="text-[10px] text-right mt-1 text-gray-500">Reach 10k to unlock interest üîí</p>
        </div>

        <div class="glass p-4 rounded-2xl mb-6">
            <h3 class="text-sm font-bold text-yellow-400 mb-3 flex items-center gap-2">üèÜ Weekly Top Savers (% Completed)</h3>
            <div id="leaderboardList" class="space-y-2">
                <p class="text-xs text-gray-500">Loading...</p>
            </div>
        </div>

        <div class="glass p-4 rounded-2xl border-l-4 border-red-500 relative">
            <h3 class="font-bold text-gray-200 mb-2">Withdraw Money</h3>
            
            <div id="withdrawLock" class="absolute inset-0 bg-gray-900/90 backdrop-blur-sm z-20 flex flex-col items-center justify-center rounded-2xl text-center p-4">
                <span class="text-3xl mb-2">üîí</span>
                <h4 class="text-red-400 font-bold text-sm">Target Not Met!</h4>
                <p class="text-xs text-gray-400">‡∂î‡∂∂‡∂ß ‡∂∏‡∑î‡∂Ø‡∂Ω‡∑ä ‡∂ú‡∂≠ ‡∑Ñ‡∑ê‡∂ö‡∑ä‡∂ö‡∑ö ‡∂â‡∂Ω‡∂ö‡∑ä‡∂ö‡∂∫ 100% ‡∑É‡∂∏‡∑ä‡∂¥‡∑ñ‡∂ª‡∑ä‡∂´ ‡∑Ä‡∑ñ ‡∑Ä‡∑í‡∂ß ‡∂¥‡∂∏‡∂´‡∑í.</p>
            </div>

            <div class="opacity-50 pointer-events-none">
                <div class="flex gap-2 mb-3">
                    <label class="flex-1 bg-green-900 p-2 rounded text-center text-xs">Cash</label>
                    <label class="flex-1 bg-blue-900 p-2 rounded text-center text-xs">Bank</label>
                </div>
                <input type="number" placeholder="Amount" class="w-full p-2 bg-gray-900 rounded mb-2">
                <button class="w-full bg-gray-600 text-white font-bold py-2 rounded">Request</button>
            </div>
            
            <div id="withdrawForm" class="hidden mt-2">
                <div class="flex gap-2 mb-3">
                    <label class="flex-1 cursor-pointer"><input type="radio" name="wType" value="cash" checked class="peer hidden"><div class="bg-gray-700 peer-checked:bg-green-600 p-2 rounded text-center text-xs">Cash üíµ</div></label>
                    <label class="flex-1 cursor-pointer"><input type="radio" name="wType" value="bank" class="peer hidden" onchange="document.getElementById('bankF').classList.toggle('hidden')"><div class="bg-gray-700 peer-checked:bg-blue-600 p-2 rounded text-center text-xs">Bank üè¶</div></label>
                </div>
                <input type="number" id="wAmount" placeholder="Amount" class="w-full p-2 bg-gray-900 border border-gray-600 rounded mb-2 text-white">
                <div id="bankF" class="hidden space-y-2 mb-2">
                    <input type="text" id="bName" placeholder="Bank Name" class="w-full p-2 bg-gray-900 border rounded text-xs">
                    <input type="text" id="bAcc" placeholder="Acc No" class="w-full p-2 bg-gray-900 border rounded text-xs">
                </div>
                <button onclick="requestWithdraw()" class="w-full bg-red-600 hover:bg-red-500 text-white font-bold py-2 rounded shadow">Request Withdraw üîì</button>
            </div>
        </div>
        
        <button onclick="logout()" class="w-full mt-8 text-gray-500 text-sm mb-10">Logout</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDoc, setDoc, doc, onSnapshot, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBQ4b_qLp51HXYJc0Trtp6yG0lO7XSudQk",
            authDomain: "cnvbankbyuandy.firebaseapp.com",
            projectId: "cnvbankbyuandy",
            storageBucket: "cnvbankbyuandy.firebasestorage.app",
            messagingSenderId: "654524804107",
            appId: "1:654524804107:web:839811f4eb33b914786b0e",
            measurementId: "G-PWWVKS8EEM"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        
        let currentUser = null;

        window.googleLogin = () => signInWithPopup(auth, provider).catch(e => alert(e.message));
        window.logout = () => signOut(auth).then(() => location.reload());

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const userRef = doc(db, "users", user.uid);
                const snap = await getDoc(userRef);

                if (!snap.exists()) {
                    await setDoc(userRef, {
                        name: user.displayName, email: user.email, photo: user.photoURL,
                        balance: 0, target: 100000, streak: 0, lastDepositDate: null // Defaults
                    });
                    location.reload();
                } else {
                    loadDashboard(snap.data());
                }
            } else {
                document.getElementById('loginView').style.display = 'flex';
                document.getElementById('dashboardView').style.display = 'none';
            }
        });

        function loadDashboard(userData) {
            document.getElementById('loginView').style.display = 'none';
            document.getElementById('dashboardView').style.display = 'block';

            document.getElementById('userName').innerText = userData.name.split(" ")[0];
            document.getElementById('userImg').src = userData.photo;

            // Live Updates
            onSnapshot(doc(db, "users", currentUser.uid), (doc) => {
                const d = doc.data();
                const bal = d.balance || 0;
                const target = d.target || 1;
                const streak = d.streak || 0;

                // 1. STREAK
                document.getElementById('streakCount').innerText = `${streak} Days Streak!`;
                if(streak >= 5) document.getElementById('streakCount').innerText += " üî• On Fire!";

                // 2. BADGES
                updateBadge('badgeBronze', bal >= 5000);
                updateBadge('badgeSilver', bal >= 10000);
                updateBadge('badgeGold', bal >= target);

                // 3. TREE ANIMATION (Based on %)
                const pct = (bal / target) * 100;
                let treeIcon = "üå±"; // Seed
                if (pct > 10) treeIcon = "üåø"; // Sprout
                if (pct > 40) treeIcon = "üå≥"; // Tree
                if (pct > 80) treeIcon = "üå≤"; // Big Forest Tree
                if (pct >= 100) treeIcon = "üéÑ"; // Decorated (Goal Met)
                
                const treeEl = document.getElementById('treeIcon');
                treeEl.innerText = treeIcon;
                // Add heartbeat animation if progress is good
                if(pct > 0) treeEl.classList.add('grow-anim');

                // 4. BARS
                document.getElementById('balanceDisplay').innerText = bal.toFixed(2);
                document.getElementById('targetDisplay').innerText = target;
                document.getElementById('targetBar').style.width = `${Math.min(pct, 100)}%`;
                document.getElementById('targetPercentText').innerText = `${pct.toFixed(1)}%`;

                // Monetization
                const moneyPct = Math.min((bal / 10000) * 100, 100);
                document.getElementById('moneyBar').style.width = `${moneyPct}%`;
                if(bal >= 10000) {
                    document.getElementById('moneyBar').classList.add('bg-green-500');
                    document.getElementById('interestStatus').innerText = "Interest Active ‚úÖ";
                    document.getElementById('interestStatus').classList.replace('text-gray-500', 'text-green-400');
                }

                // 5. WITHDRAWAL LOCK LOGIC
                if (bal >= target && bal > 0) {
                    document.getElementById('withdrawLock').classList.add('hidden'); // Unlock
                    document.getElementById('withdrawForm').classList.remove('hidden');
                } else {
                    document.getElementById('withdrawLock').classList.remove('hidden'); // Lock
                    document.getElementById('withdrawForm').classList.add('hidden');
                }
            });

            loadLeaderboard();
        }

        function updateBadge(id, isActive) {
            const el = document.getElementById(id);
            if(isActive) {
                el.classList.remove('opacity-30', 'grayscale');
                el.classList.add('scale-110', 'transition');
            } else {
                el.classList.add('opacity-30', 'grayscale');
            }
        }

        // Leaderboard based on Percentage
        async function loadLeaderboard() {
            const q = query(collection(db, "users")); // Fetch all to calc % client side for prototype
            const snap = await getDocs(q);
            let users = [];
            snap.forEach(d => {
                const u = d.data();
                if(u.balance > 0) {
                    const pct = (u.balance / u.target) * 100;
                    users.push({ name: u.name, pct: pct });
                }
            });
            
            // Sort by Percentage Descending
            users.sort((a, b) => b.pct - a.pct);
            
            const list = document.getElementById('leaderboardList');
            list.innerHTML = "";
            users.slice(0, 3).forEach((u, index) => {
                let medal = index === 0 ? 'ü•á' : (index === 1 ? 'ü•à' : 'ü•â');
                list.innerHTML += `
                    <div class="flex justify-between items-center bg-gray-800 p-2 rounded border border-gray-700">
                        <div class="flex items-center gap-2">
                            <span>${medal}</span>
                            <span class="text-sm text-gray-300">${u.name.split(" ")[0]}</span>
                        </div>
                        <span class="text-xs font-bold text-blue-400">${u.pct.toFixed(1)}% Done</span>
                    </div>
                `;
            });
        }

        window.requestWithdraw = async () => {
            const amount = parseFloat(document.getElementById('wAmount').value);
            if(!amount) return alert("Amount required");
            
            const method = document.querySelector('input[name="wType"]:checked').value;
            let details = "Cash";
            if(method === 'bank') {
                details = `${document.getElementById('bName').value} - ${document.getElementById('bAcc').value}`;
            }

            await addDoc(collection(db, "transactions"), {
                userId: currentUser.uid, userName: currentUser.displayName,
                type: "withdraw", amount: amount, method: method, details: details,
                status: "pending", date: new Date()
            });
            alert("Withdrawal Requested! Waiting for Admin.");
        };
    </script>
</body>
</html>
