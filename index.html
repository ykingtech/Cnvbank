<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CNV Super Saver</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#eab308">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2830/2830284.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Sinhala:wght@400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@500&display=swap'); /* Futuristic Font for Card */
        
        body { font-family: 'Noto Sans Sinhala', sans-serif; background: #0f172a; color: white; user-select: none; }
        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        
        .tree-container { transition: all 1s ease-in-out; }
        @keyframes grow { 0% { transform: scale(0.8); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        .grow-anim { animation: grow 2s infinite ease-in-out; }
    </style>
</head>
<body class="min-h-screen pb-24">

    <div id="installPrompt" class="hidden fixed bottom-4 left-4 right-4 bg-gray-800 p-4 rounded-xl border border-yellow-500 shadow-2xl z-50 flex justify-between items-center animate-bounce">
        <div><p class="font-bold text-white">Install App üì≤</p></div>
        <button onclick="installApp()" class="bg-yellow-500 text-black font-bold px-4 py-2 rounded-lg">Install</button>
    </div>

    <div id="loginView" class="flex flex-col justify-center items-center min-h-screen p-4">
        <h1 class="text-4xl font-bold text-yellow-400 mb-2 tracking-wider">SUPER SAVER üèÜ</h1>
        <button onclick="googleLogin()" class="bg-white text-gray-900 px-6 py-3 rounded-full font-bold shadow-lg flex items-center gap-3 mt-8 hover:scale-105 transition">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-6 h-6"> Google Login
        </button>
    </div>

    <div id="termsView" class="hidden fixed inset-0 z-40 flex items-center justify-center bg-black bg-opacity-95 p-4">
        <div class="bg-gray-800 rounded-2xl max-w-md w-full p-6 border border-yellow-500 shadow-2xl">
            <h2 class="text-xl font-bold text-yellow-400 mb-4">üìú ‡∂±‡∑ì‡∂≠‡∑í ‡∑É‡∑Ñ ‡∂ö‡∑ú‡∂±‡∑ä‡∂Ø‡∑ö‡∑É‡∑í</h2>
            <div class="h-64 overflow-y-auto text-sm text-gray-300 mb-4 bg-gray-900 p-3 rounded">
                <p class="mb-2">1. ‡∂â‡∂Ω‡∂ö‡∑ä‡∂ö‡∂∫ ‡∑É‡∂∏‡∑ä‡∂¥‡∑ñ‡∂ª‡∑ä‡∂´ ‡∑Ä‡∂± ‡∂≠‡∑ô‡∂ö‡∑ä ‡∂∏‡∑î‡∂Ø‡∂Ω‡∑ä ‡∂ë‡∂ö‡∂≠‡∑î ‡∂ö‡∑Ö ‡∂∫‡∑î‡∂≠‡∑î‡∂∫.</p>
                <p class="mb-2">2. ‡∂ª‡∑î. 10,000 ‡∂â‡∂ö‡∑ä‡∂∏‡∑Ä‡∑ñ ‡∂¥‡∑É‡∑î ‡∂¥‡∑ú‡∂Ω‡∑ì ‡∑É‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫ ‡∑Ä‡∑ö.</p>
                <p>3. Target 100% ‡∑Ä‡∑ñ ‡∑Ä‡∑í‡∂ß ‡∂∏‡∑î‡∂Ø‡∂Ω‡∑ä ‡∂ú‡∂≠ ‡∑Ñ‡∑ê‡∂ö.</p>
            </div>
            <button onclick="acceptTerms()" class="w-full bg-green-600 text-white font-bold py-3 rounded-xl">I Accept ‚úÖ</button>
        </div>
    </div>

    <div id="setupView" class="hidden min-h-screen flex flex-col justify-center items-center p-4 bg-gray-900 z-30 fixed inset-0">
        <div class="glass p-6 rounded-2xl w-full max-w-md text-center">
            <h2 class="text-2xl font-bold mb-2 text-yellow-400">üéØ Set Target</h2>
            <input type="number" id="targetAmountInput" placeholder="Ex: 100000" class="w-full p-4 bg-gray-800 border border-gray-600 rounded-xl text-white text-xl font-bold text-center mb-6">
            <div class="flex gap-2">
                <button onclick="cancelSetup()" id="btnCancelSetup" class="hidden flex-1 bg-gray-600 py-3 rounded-xl">Cancel</button>
                <button onclick="saveTarget()" class="flex-1 bg-yellow-500 text-black font-bold py-3 rounded-xl">Set Target üöÄ</button>
            </div>
        </div>
    </div>

    <div id="dashboardView" class="hidden p-4 max-w-md mx-auto">
        <div class="flex justify-between items-center mb-4">
            <div>
                <h2 class="text-xl font-bold" id="userName">User</h2>
                <div class="flex items-center gap-1 bg-orange-900/50 px-2 py-1 rounded-lg border border-orange-500/30 mt-1">
                    <span class="text-lg">üî•</span><span id="streakCount" class="text-orange-400 font-bold text-sm">0 Days</span>
                </div>
            </div>
            <img id="userImg" src="" class="w-12 h-12 rounded-full border-2 border-yellow-500">
        </div>

        <button onclick="generateCard()" class="w-full bg-gradient-to-r from-gray-800 to-black border border-yellow-500/50 text-yellow-400 font-bold py-3 rounded-xl shadow-lg mb-6 flex items-center justify-center gap-2 hover:scale-[1.02] transition">
            <span>ü™™</span> View Membership Card
        </button>

        <div class="glass p-6 rounded-3xl mb-4 text-center relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-full bg-green-500/5 z-0"></div>
            <div class="my-4 relative z-10 flex justify-center items-center h-32">
                <div id="treeIcon" class="text-9xl drop-shadow-2xl tree-container">üå±</div>
            </div>
            <h1 class="text-3xl font-bold text-white relative z-10">Rs. <span id="balanceDisplay">0.00</span></h1>
            <p class="text-xs text-gray-400 mt-1 relative z-10">Target: Rs. <span id="targetDisplay">0</span></p>
        </div>

        <button id="btnSetTarget" onclick="openTargetSetup()" class="w-full mb-6 bg-gray-700 text-gray-400 font-bold py-3 rounded-xl shadow-lg flex justify-center items-center gap-2 opacity-50" disabled>
            <span>üîí</span> Target Locked
        </button>

        <div class="glass p-4 rounded-2xl mb-6">
            <div class="flex justify-between text-xs text-gray-400 mb-1"><span>Target</span><span id="targetPercentText">0%</span></div>
            <div class="w-full bg-gray-700 rounded-full h-3 mb-4"><div id="targetBar" class="bg-blue-500 h-3 rounded-full" style="width: 0%"></div></div>
            <div class="flex justify-between text-xs text-gray-400 mb-1"><span>Monetization</span><span id="moneyPercentText">0%</span></div>
            <div class="w-full bg-gray-700 rounded-full h-3"><div id="moneyBar" class="bg-yellow-600 h-3 rounded-full" style="width: 0%"></div></div>
        </div>

        <div class="glass p-4 rounded-2xl mb-6">
            <h3 class="text-sm font-bold text-yellow-400 mb-3">üèÜ Top Savers (%)</h3>
            <div id="leaderboardList" class="space-y-2"><p class="text-xs">Loading...</p></div>
        </div>

        <div class="glass p-4 rounded-2xl border-l-4 border-red-500 relative">
            <h3 class="font-bold text-gray-200 mb-2">Withdraw</h3>
            <div id="withdrawLock" class="absolute inset-0 bg-gray-900/95 backdrop-blur-sm z-20 flex flex-col items-center justify-center p-4">
                <span class="text-2xl">üîí</span><p class="text-[10px] text-gray-400">Unlocks at 100%</p>
            </div>
            <div id="withdrawForm" class="hidden">
                <input type="number" id="wAmount" placeholder="Amount" class="w-full p-2 bg-gray-900 border rounded mb-2 text-white">
                <div class="flex gap-2 mb-2">
                     <label class="flex-1 cursor-pointer bg-gray-700 p-2 rounded text-center text-xs"><input type="radio" name="wType" value="cash" checked class="hidden">Cash</label>
                     <label class="flex-1 cursor-pointer bg-gray-700 p-2 rounded text-center text-xs"><input type="radio" name="wType" value="bank" onchange="document.getElementById('bankF').classList.remove('hidden')" class="hidden">Bank</label>
                </div>
                <div id="bankF" class="hidden space-y-2 mb-2">
                    <input type="text" id="bName" placeholder="Bank" class="w-full p-2 bg-gray-900 border rounded text-xs">
                    <input type="text" id="bAcc" placeholder="Acc No" class="w-full p-2 bg-gray-900 border rounded text-xs">
                </div>
                <button onclick="requestWithdraw()" class="w-full bg-red-600 text-white font-bold py-2 rounded">Withdraw</button>
            </div>
             <div class="opacity-0 h-20"></div>
        </div>
        
        <button onclick="logout()" class="w-full mt-8 text-gray-500 text-sm">Logout</button>
    </div>

    <div id="cardModal" class="hidden fixed inset-0 z-50 flex flex-col items-center justify-center bg-black bg-opacity-95 p-4">
        <h2 class="text-yellow-400 font-bold text-xl mb-4 tracking-widest">MEMBERSHIP CARD</h2>
        
        <canvas id="cardCanvas" width="1000" height="600" class="hidden"></canvas>
        
        <img id="cardImage" class="w-full max-w-sm rounded-xl shadow-2xl border border-yellow-600 mb-6 transform hover:scale-105 transition duration-500">
        
        <a id="downloadLink" class="w-full max-w-sm bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-xl text-center shadow-lg mb-3">
            Download Image üì•
        </a>
        <button onclick="document.getElementById('cardModal').classList.add('hidden')" class="text-gray-400 text-sm">Close</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDoc, setDoc, doc, onSnapshot, query, getDocs } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBQ4b_qLp51HXYJc0Trtp6yG0lO7XSudQk",
            authDomain: "cnvbankbyuandy.firebaseapp.com",
            projectId: "cnvbankbyuandy",
            storageBucket: "cnvbankbyuandy.firebasestorage.app",
            messagingSenderId: "654524804107",
            appId: "1:654524804107:web:839811f4eb33b914786b0e",
            measurementId: "G-PWWVKS8EEM"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        
        let currentUser = null;
        let userDataGlobal = null;

        // PWA INSTALL LOGIC
        if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');
        let deferredPrompt;
        const installBox = document.getElementById('installPrompt');
        if (window.matchMedia('(display-mode: standalone)').matches) installBox.classList.add('hidden');
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault(); deferredPrompt = e;
            if (!window.matchMedia('(display-mode: standalone)').matches) installBox.classList.remove('hidden');
        });
        window.installApp = async () => {
            if (!deferredPrompt) return;
            deferredPrompt.prompt();
            installBox.classList.add('hidden'); deferredPrompt = null;
        };

        // NAVIGATION
        function showView(viewId) {
            ['loginView', 'termsView', 'setupView', 'dashboardView'].forEach(id => {
                const el = document.getElementById(id);
                if(id === viewId) el.classList.remove('hidden'); else el.classList.add('hidden');
            });
        }

        window.googleLogin = () => signInWithPopup(auth, provider).catch(e => alert(e.message));
        window.logout = () => signOut(auth).then(() => location.reload());

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const userRef = doc(db, "users", user.uid);
                const snap = await getDoc(userRef);

                if (!snap.exists()) {
                    // Generate Unique Account Number (CNV + 10 digits)
                    const accNo = "CNV" + Math.floor(1000000000 + Math.random() * 9000000000);
                    await setDoc(userRef, {
                        name: user.displayName, email: user.email, photo: user.photoURL,
                        balance: 0, target: 0, streak: 0, termsAccepted: false,
                        accountNo: accNo, joinedDate: new Date().toLocaleDateString()
                    });
                    showView('termsView');
                } else {
                    const data = snap.data();
                    userDataGlobal = data; // Store for card generation
                    if (!data.termsAccepted) showView('termsView');
                    else if (!data.target) {
                        document.getElementById('btnCancelSetup').classList.add('hidden');
                        showView('setupView');
                    } else loadDashboard(data);
                }
            } else showView('loginView');
        });

        window.acceptTerms = async () => {
            await setDoc(doc(db, "users", currentUser.uid), { termsAccepted: true }, { merge: true });
            document.getElementById('btnCancelSetup').classList.add('hidden'); showView('setupView');
        };
        window.openTargetSetup = () => { document.getElementById('btnCancelSetup').classList.remove('hidden'); showView('setupView'); };
        window.cancelSetup = () => showView('dashboardView');
        window.saveTarget = async () => {
            const val = parseFloat(document.getElementById('targetAmountInput').value);
            if(val) { await setDoc(doc(db, "users", currentUser.uid), { target: val }, { merge: true }); location.reload(); }
        };

        function loadDashboard(d) {
            showView('dashboardView');
            document.getElementById('userName').innerText = d.name.split(" ")[0];
            document.getElementById('userImg').src = d.photo;
            userDataGlobal = d; // Update global data

            onSnapshot(doc(db, "users", currentUser.uid), (docSnap) => {
                const u = docSnap.data();
                userDataGlobal = u; // Keep updating
                
                // --- Dashboard UI Updates (Same as before) ---
                document.getElementById('streakCount').innerText = `${u.streak || 0} Days`;
                const pct = u.target ? (u.balance/u.target)*100 : 0;
                
                let treeIcon = "üå±";
                if(pct>10) treeIcon="üåø"; if(pct>40) treeIcon="üå≥"; if(pct>80) treeIcon="üå≤"; if(pct>=100) treeIcon="üéÑ";
                const treeEl = document.getElementById('treeIcon'); treeEl.innerText = treeIcon;
                if(pct>0) treeEl.classList.add('grow-anim');

                document.getElementById('balanceDisplay').innerText = u.balance.toFixed(2);
                document.getElementById('targetDisplay').innerText = u.target;
                
                document.getElementById('targetBar').style.width = `${Math.min(pct,100)}%`;
                document.getElementById('targetPercentText').innerText = `${pct.toFixed(1)}%`;
                
                const mPct = Math.min((u.balance/10000)*100, 100);
                document.getElementById('moneyBar').style.width = `${mPct}%`;
                if(u.balance >= 10000) document.getElementById('moneyBar').classList.add('bg-green-500');

                // Button Logic
                const btn = document.getElementById('btnSetTarget');
                if(u.balance >= u.target && u.balance > 0) {
                    btn.disabled = false; btn.innerHTML = "üéØ Set New Target"; btn.classList.replace('opacity-50','bg-yellow-500');
                    document.getElementById('withdrawLock').classList.add('hidden');
                    document.getElementById('withdrawForm').classList.remove('hidden');
                } else {
                    btn.disabled = true; btn.innerHTML = "üîí Target Locked"; btn.classList.add('opacity-50');
                    document.getElementById('withdrawLock').classList.remove('hidden');
                    document.getElementById('withdrawForm').classList.add('hidden');
                }
            });
            loadLeaderboard();
        }

        async function loadLeaderboard() {
            const q = query(collection(db, "users")); 
            const snap = await getDocs(q);
            let users = [];
            snap.forEach(d => { const u = d.data(); if(u.balance>0) users.push({n:u.name, p:(u.balance/u.target)*100}); });
            users.sort((a,b)=>b.p-a.p);
            document.getElementById('leaderboardList').innerHTML = users.slice(0,3).map((u,i)=>
                `<div class="flex justify-between bg-gray-800 p-2 rounded border border-gray-700 text-sm"><span>${i==0?'ü•á':i==1?'ü•à':'ü•â'} ${u.n.split(" ")[0]}</span><span class="text-blue-400 font-bold">${u.p.toFixed(1)}%</span></div>`
            ).join('');
        }

        window.requestWithdraw = async () => {
             // ... (Withdraw logic same as before)
             alert("Withdrawal Requested!");
        };

        // --- 6. SUPER CARD GENERATOR LOGIC ---
        window.generateCard = () => {
            const canvas = document.getElementById('cardCanvas');
            const ctx = canvas.getContext('2d');
            const u = userDataGlobal;

            // 1. Background (Premium Gold/Black Gradient)
            const grad = ctx.createLinearGradient(0, 0, 1000, 600);
            grad.addColorStop(0, '#000000');
            grad.addColorStop(0.4, '#1a1a1a');
            grad.addColorStop(1, '#2c2c2c');
            ctx.fillStyle = grad;
            ctx.fillRect(0, 0, 1000, 600);

            // 2. Gold Border
            ctx.strokeStyle = '#eab308';
            ctx.lineWidth = 15;
            ctx.strokeRect(20, 20, 960, 560);

            // 3. Header Text
            ctx.font = 'bold 50px sans-serif';
            ctx.fillStyle = '#eab308';
            ctx.fillText('CNV SUPER SAVER', 60, 100);
            
            ctx.font = '30px sans-serif';
            ctx.fillStyle = '#cccccc';
            ctx.fillText('PREMIUM MEMBER', 60, 150);

            // 4. Chip Icon (Simple Draw)
            ctx.fillStyle = '#d4af37'; // Gold chip color
            ctx.fillRect(60, 200, 120, 100);
            ctx.strokeStyle = '#b8860b';
            ctx.lineWidth = 2;
            ctx.strokeRect(60, 200, 120, 100);
            // Chip lines
            ctx.beginPath(); ctx.moveTo(60, 233); ctx.lineTo(180, 233); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(60, 266); ctx.lineTo(180, 266); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(120, 200); ctx.lineTo(120, 300); ctx.stroke();

            // 5. Account Number (Monospace)
            ctx.font = 'bold 70px "Courier New", monospace';
            ctx.fillStyle = '#ffffff';
            ctx.shadowColor = "rgba(0,0,0,0.5)";
            ctx.shadowBlur = 10;
            // Format: CNV 1234 5678...
            const acc = u.accountNo || "CNV0000000000";
            const formattedAcc = acc.replace(/(.{4})/g, '$1 ').trim();
            ctx.fillText(formattedAcc, 60, 420);

            // 6. User Name
            ctx.shadowBlur = 0;
            ctx.font = '40px sans-serif';
            ctx.fillStyle = '#eab308';
            ctx.fillText(u.name.toUpperCase(), 60, 520);

            // 7. Joined Date
            ctx.font = '30px sans-serif';
            ctx.fillStyle = '#888888';
            ctx.textAlign = 'right';
            ctx.fillText(`MEMBER SINCE: ${u.joinedDate || '2025'}`, 920, 520);

            // 8. Convert to Image & Show Modal
            const dataUrl = canvas.toDataURL("image/png");
            document.getElementById('cardImage').src = dataUrl;
            document.getElementById('downloadLink').href = dataUrl;
            document.getElementById('downloadLink').download = `CNV_Card_${u.name.split(" ")[0]}.png`;
            
            document.getElementById('cardModal').classList.remove('hidden');
        };

    </script>
</body>
</html>
