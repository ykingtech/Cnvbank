<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CNV Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>body { font-family: sans-serif; }</style>
</head>
<body class="bg-gray-900 text-white p-4">

    <div class="max-w-4xl mx-auto">
        <header class="flex justify-between items-center mb-6 border-b border-gray-700 pb-4">
            <h1 class="text-2xl font-bold text-yellow-400">üëë CNV ADMIN</h1>
            <button onclick="location.reload()" class="text-sm text-gray-400 hover:text-white">Refresh</button>
        </header>

        <div class="flex gap-2 mb-6">
            <button onclick="switchTab('users')" id="btn-users" class="flex-1 bg-blue-600 hover:bg-blue-500 py-3 rounded-lg font-bold transition">
                üí∞ Collect Money (Users)
            </button>
            <button onclick="switchTab('withdraw')" id="btn-withdraw" class="flex-1 bg-gray-700 hover:bg-gray-600 py-3 rounded-lg font-bold transition relative">
                üì§ Withdraw Requests
                <span id="reqCount" class="absolute top-0 right-0 -mt-2 -mr-2 bg-red-600 text-xs rounded-full h-6 w-6 flex items-center justify-center hidden">0</span>
            </button>
        </div>

        <div id="view-users">
            <h2 class="text-lg font-bold mb-4 text-gray-300">All Active Users</h2>
            <div id="usersList" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <p class="text-gray-500">Loading users...</p>
            </div>
        </div>

        <div id="view-withdraw" class="hidden">
            <h2 class="text-lg font-bold mb-4 text-gray-300">Pending Withdrawals (‡∂Ö‡∂±‡∑î‡∂∏‡∂≠ ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∂ß ‡∂á‡∂≠‡∑í)</h2>
            <div id="withdrawList" class="space-y-4">
                <p class="text-gray-500">No pending requests.</p>
            </div>
        </div>
    </div>

    <div id="moneyModal" class="fixed inset-0 bg-black bg-opacity-90 hidden flex items-center justify-center p-4 z-50">
        <div class="bg-gray-800 p-6 rounded-xl w-full max-w-sm border border-green-500">
            <h3 class="text-xl font-bold mb-2">üí∞ Collect Daily Cash</h3>
            <p class="text-gray-400 text-sm mb-4">User: <span id="modalUserName" class="text-white font-bold"></span></p>
            <input type="number" id="addAmount" placeholder="Amount (Rs)" class="w-full p-3 bg-gray-900 border border-gray-600 rounded mb-4 text-white font-bold text-lg">
            <button onclick="confirmAddMoney()" class="w-full bg-green-600 hover:bg-green-500 p-3 rounded font-bold">Confirm Deposit & Update Streak üî•</button>
            <button onclick="closeModal()" class="w-full mt-3 text-gray-500 text-sm">Cancel</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, query, where, updateDoc, doc, increment, addDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyBQ4b_qLp51HXYJc0Trtp6yG0lO7XSudQk",
            authDomain: "cnvbankbyuandy.firebaseapp.com",
            projectId: "cnvbankbyuandy",
            storageBucket: "cnvbankbyuandy.firebasestorage.app",
            messagingSenderId: "654524804107",
            appId: "1:654524804107:web:839811f4eb33b914786b0e",
            measurementId: "G-PWWVKS8EEM"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        let selectedUserId = null;
        let selectedUserName = null;

        // --- TAB SWITCHING ---
        window.switchTab = (tab) => {
            document.getElementById('view-users').classList.add('hidden');
            document.getElementById('view-withdraw').classList.add('hidden');
            document.getElementById('btn-users').className = "flex-1 py-3 rounded-lg font-bold transition " + (tab === 'users' ? 'bg-blue-600' : 'bg-gray-700');
            document.getElementById('btn-withdraw').className = "flex-1 py-3 rounded-lg font-bold transition relative " + (tab === 'withdraw' ? 'bg-red-600' : 'bg-gray-700');
            
            document.getElementById('view-' + tab).classList.remove('hidden');
        };

        // --- 1. LOAD USERS (For Deposits) ---
        onSnapshot(collection(db, "users"), (snap) => {
            const list = document.getElementById('usersList');
            list.innerHTML = "";
            snap.forEach(docSnap => {
                const u = docSnap.data();
                const uid = docSnap.id;
                // Progress Bar for Admin View
                const pct = u.target ? Math.min((u.balance / u.target) * 100, 100).toFixed(0) : 0;
                
                list.innerHTML += `
                    <div class="bg-gray-800 p-4 rounded-xl border border-gray-700 hover:border-blue-500 transition">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <p class="font-bold text-lg">${u.name}</p>
                                <div class="flex items-center gap-2">
                                    <span class="text-xs bg-orange-900 text-orange-300 px-1 rounded">üî• ${u.streak || 0}</span>
                                    <span class="text-xs text-gray-400">Target: Rs.${u.target}</span>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="font-bold text-xl text-green-400">Rs. ${u.balance}</p>
                                <p class="text-xs text-blue-300">${pct}% Done</p>
                            </div>
                        </div>
                        <div class="w-full bg-gray-700 h-1.5 rounded-full mb-3">
                            <div class="bg-blue-500 h-1.5 rounded-full" style="width: ${pct}%"></div>
                        </div>
                        <button onclick="openAddMoney('${uid}', '${u.name}')" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-2 rounded font-bold text-sm">
                            + Add Money
                        </button>
                    </div>
                `;
            });
        });

        // --- 2. LOAD WITHDRAW REQUESTS (New Feature) ---
        const qReq = query(collection(db, "transactions"), where("status", "==", "pending"), where("type", "==", "withdraw"));
        
        onSnapshot(qReq, (snap) => {
            const list = document.getElementById('withdrawList');
            const countBadge = document.getElementById('reqCount');
            
            list.innerHTML = "";
            
            if(snap.empty) {
                list.innerHTML = "<p class='text-gray-500 text-center py-10'>No pending withdrawal requests. ‚úÖ</p>";
                countBadge.classList.add('hidden');
            } else {
                countBadge.innerText = snap.size;
                countBadge.classList.remove('hidden');
            }

            snap.forEach(docSnap => {
                const t = docSnap.data();
                const isBank = t.method === 'bank';
                
                list.innerHTML += `
                    <div class="bg-gray-800 p-5 rounded-xl border-l-4 border-red-500 shadow-lg">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="font-bold text-lg text-white">${t.userName}</h3>
                                <p class="text-xs text-gray-400">${new Date(t.date.seconds * 1000).toLocaleString()}</p>
                            </div>
                            <h2 class="text-2xl font-bold text-red-400">Rs. ${t.amount}</h2>
                        </div>

                        <div class="mt-3 bg-gray-900 p-3 rounded text-sm">
                            <p class="text-gray-400 uppercase text-xs font-bold mb-1">Withdraw Method:</p>
                            <p class="text-white font-bold flex items-center gap-2">
                                ${isBank ? 'üè¶ Bank Transfer' : 'üíµ Cash Handover'}
                            </p>
                            <p class="text-yellow-300 mt-1 font-mono">${t.details}</p>
                        </div>

                        <button onclick="approveWithdraw('${docSnap.id}', '${t.userId}', ${t.amount})" 
                            class="w-full mt-4 bg-green-600 hover:bg-green-500 text-white py-3 rounded font-bold text-sm shadow-lg transition transform active:scale-95">
                            ‚úÖ Approve & Deduct Balance
                        </button>
                    </div>
                `;
            });
        });

        // --- FUNCTIONS ---

        // 1. Approve Withdrawal
        window.approveWithdraw = async (txId, uid, amount) => {
            if(!confirm(`Are you sure you want to approve this withdrawal of Rs. ${amount}?`)) return;

            try {
                // Update Transaction Status
                await updateDoc(doc(db, "transactions", txId), { status: "success" });
                
                // Deduct Balance from User
                await updateDoc(doc(db, "users", uid), { 
                    balance: increment(-amount) 
                    // Note: We do NOT reset the target here, user can set new one in their app
                });
                
                alert("Withdrawal Approved! Balance Updated.");
            } catch (e) {
                alert("Error: " + e.message);
            }
        };

        // 2. Add Money Modal
        window.openAddMoney = (uid, name) => {
            selectedUserId = uid;
            selectedUserName = name;
            document.getElementById('modalUserName').innerText = name;
            document.getElementById('moneyModal').classList.remove('hidden');
        };

        window.closeModal = () => {
            document.getElementById('moneyModal').classList.add('hidden');
            document.getElementById('addAmount').value = "";
        };

        window.confirmAddMoney = async () => {
            const amount = parseFloat(document.getElementById('addAmount').value);
            if(!amount) return alert("Enter amount");

            // Streak Logic
            const userRef = doc(db, "users", selectedUserId);
            const userSnap = await getDoc(userRef);
            const userData = userSnap.data();
            
            let newStreak = userData.streak || 0;
            const lastDate = userData.lastDepositDate ? userData.lastDepositDate.toDate() : null;
            const today = new Date();

            if (lastDate) {
                const d1 = new Date(lastDate.setHours(0,0,0,0));
                const d2 = new Date(today.setHours(0,0,0,0));
                const diffDays = Math.ceil(Math.abs(d2 - d1) / (1000 * 60 * 60 * 24));

                if (diffDays === 1) newStreak++; 
                else if (diffDays > 1) newStreak = 1; 
            } else {
                newStreak = 1;
            }

            // Update User
            await updateDoc(userRef, {
                balance: increment(amount),
                streak: newStreak,
                lastDepositDate: new Date()
            });

            // Log Transaction
            await addDoc(collection(db, "transactions"), {
                userId: selectedUserId,
                userName: selectedUserName,
                type: "deposit",
                amount: amount,
                date: new Date(),
                method: "Admin Collected",
                status: "success"
            });

            alert(`Collected Rs.${amount} from ${selectedUserName}!`);
            closeModal();
        };
    </script>
</body>
</html>
